FROM ubuntu:focal

COPY openl-tablets-demo.zip demo.zip

RUN set -eux ; \
    \
# Prepare environment. Install required utils for Docker image building.
    savedAptMark="$(apt-mark showmanual)"; \
    \
    apt-get update ; \
    apt-get install -y --no-install-recommends \
    unzip \
    ; \
    \
# Clean up temporaries
    rm -rf /var/lib/apt/lists/* ; \
    \
# Unpack demo files
    unzip -q demo.zip ; \
    rm demo.zip ; \
    \
    demoDir=$(ls | grep jetty-) ; \
    mv "$demoDir" /demo ; \
    \
    cd demo/webapps ; \
    \
# Permission for rootless mode (for running as non-root)
    cd .. ; \
    touch jetty.state; \
    chmod 777 jetty.state; \
    mkdir logs; \
    chmod 777 logs; \
    chmod 777 -R openl-demo

FROM ubuntu:focal

# Copy Java
ENV JAVA_HOME /opt/java/openjdk
ENV JAVA $JAVA_HOME/bin/java
COPY --from=eclipse-temurin:11-jre-focal $JAVA_HOME $JAVA_HOME

# Install fonts required for Apache POI (export into Excel with autowidth of columns)
RUN set -eux ; \
    \
    apt-get update ; \
    apt-get install -y --no-install-recommends \
    fontconfig ; \
    rm -rf /var/lib/apt/lists/*

RUN useradd -r -m -U -s /usr/sbin/nologin openl
USER openl

ENV JAVA_OPTIONS "$JAVA_OPTIONS $JAVA_OPTS -XX:MaxRAMPercentage=90.0"

EXPOSE 8080
#Start Jetty
CMD export JETTY_ARGS="-Dopenl.home=./openl-demo -Dws.port=8080 $JETTY_ARGS" && bin/jetty.sh run && tail -f /dev/null

COPY --from=0 /demo /demo
WORKDIR /demo
