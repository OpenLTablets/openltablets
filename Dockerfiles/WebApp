ARG JDK=11-jre-focal

FROM eclipse-temurin:${JDK} as jdk

FROM ubuntu:focal

ARG APP=target/webapp

# Copy Java
ENV JAVA_HOME /opt/java/openjdk
COPY --from=jdk $JAVA_HOME $JAVA_HOME

ENV OPENL_DIR /opt/openl
ENV OPENL_HOME $OPENL_DIR/local
ENV OPENL_HOME_SHARED $OPENL_DIR/shared
ENV OPENL_APP $OPENL_DIR/app
ENV OPENL_LIB $OPENL_DIR/lib

ENV JETTY_HOME $OPENL_APP
ENV JETTY_BASE $OPENL_APP

COPY --from=jetty:9-jre11-slim /usr/local/jetty $JETTY_HOME
COPY --from=jetty:9-jre11-slim /var/lib/jetty $JETTY_BASE
RUN set -eux ; \
\
# Create start file for Jetty with configuration options
    mkdir $OPENL_LIB; \
    ln -s $OPENL_LIB $JETTY_HOME/lib/ext; \
    echo '#!/usr/bin/env bash\n\n\
export JAVA_OPTIONS=$JAVA_OPTS\ $JAVA_OPTIONS\n \
source $JETTY_HOME/bin/jetty.sh run\n' >> $JETTY_HOME/bin/start.sh; \
    chmod +x $JETTY_HOME/bin/start.sh; \
\
# Install fonts required for Apache POI (export into Excel with autowidth of columns)
    apt-get update; \
    chmod +x ${JETTY_HOME}/bin/jetty.sh; \
    \
    apt-get install -y --no-install-recommends \
    fontconfig ; \
    rm -rf /var/lib/apt/lists/*; \
# Permission for rootless mode (for running as non-root)
    cd .. ; \
    touch $JETTY_HOME/start.state; \
    mkdir $JETTY_HOME/logs; \
    chmod 777 $JETTY_HOME/logs $JETTY_HOME/start.state; \
    chmod 777 -R $OPENL_LIB

# Define executables
ENV PATH $JETTY_HOME/bin:$JAVA_HOME/bin:$PATH

ENV JAVA_OPTS="-Xms32m -XX:MaxRAMPercentage=90.0"

# Create a system 'openl' user with home directory. Home directory is required for Java Prefs persistence to prevent
# WARN spamming in the log.
# UID=1000 as a de-facto standard in k8s examples.
RUN useradd -r -m -U -s /usr/sbin/nologin openl -u 1000

# Writable folder for 'openl' user where application files are stored.
# It should be mounted on an external volume to persist application data between redeploying if it is required.
# Do not confuse this with home directory of 'openl' user.
RUN mkdir -p "$OPENL_HOME" && chown openl:openl "$OPENL_HOME"
RUN mkdir -p "$OPENL_HOME_SHARED" && chown openl:openl "$OPENL_HOME_SHARED"
# Running a container under a non-root user
USER openl

EXPOSE 8080
WORKDIR $JETTY_BASE

CMD ["/bin/bash", "-c", "$JETTY_HOME/bin/start.sh"]

COPY $APP webapps/ROOT

WORKDIR $OPENL_DIR
