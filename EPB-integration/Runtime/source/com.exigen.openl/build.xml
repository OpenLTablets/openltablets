<project name="OpenL" default="build-run-time" basedir=".">

	<description>
	    This script is designed to build runtime projects.
	</description>

	<property name="projectDirectory" value="../" />
	<property name="buildId" value="7.0.0-SNAPSHOT" />
	<property name="versionReplace" value="false" />
	<property name="versionReplaceList" value="com.exigen.openl=${buildId}" />

	<target name="build-run-time">
		<copy file="pom.xml" todir="${projectDirectory}" overwrite="true"/>

		<antcall target="create-snapshot-build" />
		<antcall target="create-release-build" />
	</target>

	<!-- Create build with default SNAPSHOT version and deploy it to repository-->
	<target name="create-snapshot-build">

		<condition property="maven.test.skip" value="true" else="false">
			<istrue value="${maven.test.skip}"/>
		</condition>
			
		<exec dir="${projectDirectory}" executable="mvn.bat" failonerror="true">
			<arg line="-Dmaven.test.skip=${maven.test.skip}" />
			<arg line="-e" />
			<arg line="-U" />
			<arg line="clean" />
			<arg line="install" />
			<env key="versionReplace" value="false"/>
			<env key="MAVEN_TERMINATE_CMD" value="on" />
		</exec>

		<antcall target="deploy-to-repository" />
	</target>

	<!-- Create build with updated version and deploy it to repository -->
	<target name="create-release-build" if="releaseBuild">	
		
		<antcall target="validate-pom" />

		<exec dir="${projectDirectory}" executable="mvn.bat" failonerror="true">
			<arg line="-e" />
			<arg line="-U" />			
			<arg line="install" />
			<env key="MAVEN_TERMINATE_CMD" value="on" />
			<env key="versionReplace" value="false"/>		
		</exec>

		<antcall target="deploy-to-repository" />
	</target>	
	
	<!-- Change version to required ones -->
	<target name="validate-pom">
		<exec dir="${projectDirectory}" executable="mvn.bat" failonerror="true">
			<arg line="-e" />
			<arg line="-U" />
			<arg line="clean" />
			<arg line="validate" />
			<env key="MAVEN_TERMINATE_CMD" value="on" />
			<env key="versionReplace" value="${versionReplace}"/>
			<env key="versionReplaceList" value="${versionReplaceList}"/>
		</exec>
	</target>	

	<!-- Deploy to repository -->
	<target name="deploy-to-repository" if="release">
		<tstamp>
			<format property="buildDate" pattern="d-MMMM-yyyy" locale="en,UK"/>
		</tstamp>
		<exec dir="${projectDirectory}" executable="mvn.bat" failonerror="true">
			<arg line="-e" />
			<arg line="-U" />
			<arg line="javadoc:jar" />
			<arg line="deploy" />
			<env key="buildDate" value="${buildDate}" />
			<env key="MAVEN_TERMINATE_CMD" value="on" />
		</exec>
	</target>
</project>

