<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

    <bean id="jaxrsServicesLoggingFeature" class="org.openl.rules.ruleservice.storelogdata.LoggingFeature">
        <property name="loggingEnabled" value="${ruleservice.logging.enabled}"/>
    </bean>

    <bean id="jaxrsSwaggerAndOpenApiObjectMapperParent"
          class="org.openl.rules.ruleservice.publish.jaxrs.swagger.SchemaJacksonObjectMapperFactoryBean"
          scope="prototype" abstract="true">
        <property name="overrideTypesAsString" value="${ruleservice.databinding.rootClassNames}"/>
        <property name="supportVariations" value="${ruleservice.isSupportVariations}"/>
        <property name="xlsModuleOpenClass" ref="serviceXlsModuleOpenClass"/>
        <property name="rulesDeploy" ref="serviceRulesDeploy"/>
    </bean>

    <bean id="jaxrsProjectJacksonObjectMapperFactoryBean"
          class="org.openl.rules.serialization.ProjectJacksonObjectMapperFactoryBean" scope="prototype">
        <property name="overrideTypesAsString" value="${ruleservice.databinding.rootClassNames}"/>
        <property name="caseInsensitiveProperties" value="${ruleservice.jackson.caseInsensitiveProperties}"/>
        <property name="defaultDateFormatAsString" value="${ruleservice.jackson.defaultDateFormat}"/>
        <property name="failOnUnknownProperties" value="${ruleservice.jackson.failOnUnknownProperties}"/>
        <property name="defaultTypingMode" value="${ruleservice.jackson.defaultTypingMode}"/>
        <property name="supportVariations" value="${ruleservice.isSupportVariations}"/>
        <property name="serializationInclusion" value="${ruleservice.jackson.serializationInclusion}"/>
        <property name="polymorphicTypeValidation" value="true"/>
        <property name="xlsModuleOpenClass" ref="serviceXlsModuleOpenClass"/>
        <property name="rulesDeploy" ref="serviceRulesDeploy"/>
    </bean>

    <bean id="jaxrsJacksonObjectMapper"
          class="org.openl.rules.ruleservice.databinding.ServiceJacksonObjectMapperEnhancerFactoryBean"
          scope="prototype">
        <property name="jacksonObjectMapperFactory" ref="jaxrsProjectJacksonObjectMapperFactoryBean"/>
    </bean>

    <bean id="jaxrsServiceConfigurationResolveMethodParameterNamesFactoryBean"
          class="org.openl.rules.ruleservice.databinding.ServiceConfigurationBooleanFactoryBean" scope="prototype">
        <property name="propertyName" value="jaxrs.resolveMethodParameterNames"/>
        <property name="defaultValue" value="${ruleservice.jaxrs.resolveMethodParameterNames:true}"/>
    </bean>

    <bean id="jaxrsSwaggerObjectMapper"
          class="org.openl.rules.ruleservice.publish.jaxrs.swagger.jackson.SwaggerObjectMapperConfigurationFactoryBean"
          scope="prototype">
        <property name="objectMapper">
            <bean class="org.openl.rules.ruleservice.databinding.ServiceJacksonObjectMapperEnhancerFactoryBean">
                <property name="jacksonObjectMapperFactory">
                    <bean parent="jaxrsSwaggerAndOpenApiObjectMapperParent">
                        <property name="objectMapperFactory">
                            <bean class="org.openl.rules.ruleservice.publish.jaxrs.swagger.jackson.SwaggerObjectMapperFactory"/>
                        </property>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="jaxrsOpenApiObjectMapper"
          class="org.openl.rules.ruleservice.publish.jaxrs.swagger.jackson.OpenApiObjectMapperConfigurationFactoryBean"
          scope="prototype">
        <property name="objectMapper">
            <bean class="org.openl.rules.ruleservice.databinding.ServiceJacksonObjectMapperEnhancerFactoryBean">
                <property name="jacksonObjectMapperFactory">
                    <bean parent="jaxrsSwaggerAndOpenApiObjectMapperParent">
                        <property name="objectMapperFactory">
                            <bean class="org.openl.rules.ruleservice.publish.jaxrs.swagger.jackson.OpenApiObjectMapperFactory"/>
                        </property>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="jaxrsTextPlainDateMessageBodyWriter"
          class="org.openl.rules.ruleservice.databinding.TextPlainDateMessageBodyWriter"/>

    <bean id="jaxrsJSONProvider" class="com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider" scope="prototype">
        <constructor-arg ref="jaxrsJacksonObjectMapper"/>
    </bean>

    <bean id="jaxrsWebApplicationExceptionMapper" class="org.apache.cxf.jaxrs.impl.WebApplicationExceptionMapper">
        <property name="addMessageToResponse" value="true"/>
    </bean>

    <bean id="jaxrs200StatusOutInterceptor"
          class="org.openl.rules.ruleservice.publish.jaxrs.JAXRS200StatusOutInterceptor">
        <property name="enabled" value="${ruleservice.jaxrs.responseStatusAlwaysOK}"/>
    </bean>

    <bean id="wadlGenerator" class="org.apache.cxf.jaxrs.model.wadl.WadlGenerator" scope="prototype">
        <property name="linkAnyMediaTypeToXmlSchema" value="true"/>
        <property name="supportCollections" value="false"/>
        <property name="extraClasses">
            <bean class="org.openl.rules.ruleservice.databinding.SetToListOfClassesFactoryBean">
                <property name="setOfClassNames">
                    <bean class="org.openl.rules.ruleservice.databinding.ServiceRootClassNamesBindingFactoryBean">
                        <property name="overrideTypesAsString" value="${ruleservice.databinding.rootClassNames}"/>
                    </bean>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="jaxrsExceptionMapper" class="org.openl.rules.ruleservice.publish.jaxrs.JAXRSExceptionMapper"/>

    <bean id="jaxrsServiceServerPrototype" class="org.apache.cxf.jaxrs.JAXRSServerFactoryBean" scope="prototype">
        <property name="features">
            <list>
                <ref bean="jaxrsServicesLoggingFeature"/>
            </list>
        </property>
        <property name="outFaultInterceptors">
            <list>
                <ref bean="jaxrs200StatusOutInterceptor"/>
            </list>
        </property>
        <property name="outInterceptors">
            <list>
                <ref bean="jaxrs200StatusOutInterceptor"/>
            </list>
        </property>
        <property name="providers">
            <list>
                <ref bean="jaxrsExceptionMapper"/>
                <ref bean="wadlGenerator"/>
                <ref bean="jaxrsJSONProvider"/>
                <ref bean="jaxrsTextPlainDateMessageBodyWriter"/>
                <ref bean="jaxrsWebApplicationExceptionMapper"/>
            </list>
        </property>
        <property name="bus" ref="cxf"/>
    </bean>

    <!-- Initializes OpenL Engine instances according to Rule Services configuration description and calls RuleServicePublisher
        to expose corresponding web service -->
    <!-- Exposes web services. -->
    <bean id="jaxrsServiceEnhancer" class="org.openl.rules.ruleservice.publish.jaxrs.JAXRSOpenLServiceEnhancer"
          scope="prototype">
        <property name="resolveMethodParameterNames"
                  ref="jaxrsServiceConfigurationResolveMethodParameterNamesFactoryBean"/>
    </bean>

    <bean id="jaxrsServicesRuleServicePublisher" class="org.openl.rules.ruleservice.publish.JAXRSRuleServicePublisher">
        <property name="storeLogDataEnabled" value="${ruleservice.store.logs.enabled}"/>
        <property name="swaggerPrettyPrint" value="${ruleservice.jaxrs.swagger.prettyprint}"/>
    </bean>

</beans>
