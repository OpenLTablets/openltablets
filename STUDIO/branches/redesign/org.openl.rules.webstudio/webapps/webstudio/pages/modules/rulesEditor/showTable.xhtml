<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rules="http://openl-tablets.sourceforge.net/jsf">

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />
    <c:set var="rulesEditor" value="#{contextPath}/faces/pages/modules/rulesEditor" />

    <style>
        /* TODO Create Button plugin */
        .editToolbar {
            float: left;
            margin-right: 50px;
            border-bottom: 1px solid rgb(170,170,170);
            background: -moz-linear-gradient(top, #FEFEFE, #F7F7F7);
            background: -webkit-linear-gradient(top, #FEFEFE, #F7F7F7);
            background: -ms-linear-gradient(top, #FEFEFE, #F7F7F7);
            background: linear-gradient(top, #FEFEFE, #F7F7F7);
            filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=#FEFEFE, endColorstr=#F7F7F7, GradientType=0);
        }
        .toolbarButton, .checkboxButton {
            position: relative;
            display: inline-block;
            text-decoration: none;
            color: #313131;
            padding: 4px 8px 4px 24px;
        }
        .checkboxButton {
            cursor: pointer;
            padding: 13px 1px 13px 24px;
        }
        .toolbarButton:hover, .checkboxButton:hover {
            color: #000000;
            box-shadow: 0 0 1px #99BBFF;
            background: #E8EFF7;
        }
        .toolbarButton img, .checkboxButton input {
            position: absolute;
            left: 4px;
            top: 2px;
        }
        .checkboxButton input {
            left: 2px;
            top: 10px;
        }
        .toolbarButton .arrow, .checkboxButton .arrow {
            background: url('webresource/images/arrow_down.png') no-repeat center;
            padding: 2px 2px;
        }
        .toolbarButton .arrow:hover {
            background-color: #BBCCDD;
        }
        .bigButton {
            padding: 4px 7px;
            text-align: center;
        }
        .bigButton img {
            position: static;
        }
        .bigButton > span {
            display: block;
            margin-top: 3px;
        }
        .editToolbar .delimeter {
            border-left: 1px solid white;
            border-right: 1px solid rgba(215,215,215,0.7);
            padding: 0;
        }
        .editToolbar .blockHeader {
            text-align: center;
            color: #888888;
            font-size: 90%;
        }
     </style>

     <script>
        function open_win(url, name) {
            window.open(url, name, "toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, copyhistory=yes, width=900, height=700, top=20, left=100")
        }

        function showButtonMenu(event, id, buttonElem) {
            var button = $j(event.target).parent(buttonElem);
            if (!button.length)
                button = $j(event.target).closest(buttonElem);
            var buttonPos = button.position();

            event.stopPropagation();

            $j("#" + id).popup({
                left: buttonPos.left,
                top : buttonPos.top + button.outerHeight()
            });
        }
    </script>

    <c:if test="#{!showTableBean.dispatcherValidationNode}">
    <div class="editToolbar">
        <table>
            <tr>

                <!-- First Block -->
                <c:if test="#{showTableBean.editable}">
                <td>
                    <h:form prependId="false">
                        <table>
                            <tr>
                                <td>
                                    <h:outputLink value="#{contextPath}/faces/pages/modules/rulesEditor/showTable.xhtml"
                                        title="Edit Table" target="content" styleClass="toolbarButton">
                                        <f:param name="uri" value="#{showTableBean.uri}" />
                                        <f:param name="mode" value="edit" />
                                        <img src="webresource/images/editTable.gif" />
                                        <span>Edit</span>
                                    </h:outputLink>
                                </td>
                                <td>
                                    <a4j:commandLink action="#{tableCopierWizardManager.start}" rendered="#{showTableBean.copyable}"
                                        oncomplete="goTo('#{rulesEditor}/copyTable.xhtml', 'content')" title="Copy Table"
                                        styleClass="toolbarButton">
                                        <img src="webresource/images/copyTable.gif" />
                                        <span>Copy</span>
                                    </a4j:commandLink>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <h:outputLink value="#{contextPath}/action/launch" styleClass="toolbarButton"
                                        title="Open Table In Excel - #{showTableBean.uri}" target="hidden" >
                                        <f:param name="uri" value="#{showTableBean.uri}" />
                                        <img src="webresource/images/excel.png" />
                                        <span>Open in Excel</span>
                                    </h:outputLink>
                                </td>
                                <td>
                                    <a4j:commandLink action="#{showTableBean.removeTable}" title="Remove Table"
                                        onclick="if(!confirm('Do you really want to remove this table?'))return false;"
                                        styleClass="toolbarButton">
                                        <img src="webresource/images/delete.gif" />
                                        <span>Remove</span>
                                    </a4j:commandLink>
                                </td>
                            </tr>
                        </table>
                    </h:form>
                </td>
                </c:if>

                <!-- Delimeter -->
                <td class="delimeter"></td>

                <c:if test="#{showTableBean.testable and !showTableBean.hasErrors}">

                <!-- Second Block -->
                <td>
                    <c:set var="testIndices" value="#{showTableBean.selectedIndices}" />
                    <c:set var="traceUrl"
                        value="#{contextPath}/faces/pages/layout/frameView.xhtml?title=Trace&amp;treePage=faces/pages/modules/rulesEditor/trace/tree.xhtml&amp;relWidth=70&amp;mainPage=faces/pages/modules/rulesEditor/trace/showTraceTable.xhtml&amp;first=true&amp;uri=#{showTableBean.encodedUri}" />
                    <h:form prependId="false">
                        <table>
                            <tr>
                                <td>
                                    <span class="checkboxButton" title="Select Units to Perform">
                                        <h:selectBooleanCheckbox id="selectAll" onclick="selectAllTests()" value="true" />
                                        <span onclick="showButtonMenu(event, 'unitsMenu', 'span')">Units</span>
                                        <span onclick="showButtonMenu(event, 'unitsMenu', 'span')" class="arrow" >
                                            <f:verbatim>&amp;nbsp;&amp;nbsp;</f:verbatim>
                                        </span>
                                    </span>
                                    <div id="unitsMenu" style="display: none">
                                        <table id="testTable" class="testtable" style="border: 1px solid white">
                                            <ui:repeat var="test" value="#{showTableBean.tests}">
                                            <tr style="vertical-align: top">
                                                <td>
                                                    <h:selectBooleanCheckbox value="#{showTableBean.selectedTests[test]}" />
                                                </td>
                                                <td>
	                                                <ui:include src="/pages/modules/rulesEditor/test/showTestCase.xhtml">
	                                                    <ui:param name="args" value="#{test.executionParams}" />
	                                                </ui:include>
	                                            </td>
                                            </tr>
                                            </ui:repeat>
                                        </table>
                                    </div>
                                </td>
                                <td>
                                    <c:set var="runLink"
                                        value="#{showTableBean.table.type == 'xls.run.method' ? 'test/runTestMethod.xhtml' : 'test/runAllTests.xhtml'}" />
                                    <a4j:commandLink action="#{showTableBean.makeTestSuite}" title="Run" styleClass="toolbarButton bigButton"
                                        onclick="return isAnyTestSelected();" oncomplete="goTo('#{runLink}', 'content')">
                                        <img src="webresource/images/run.gif" />
                                        <span>Run</span>
                                    </a4j:commandLink>
                                </td>
                                <td>
                                    <a4j:commandLink action="#{showTableBean.makeTestSuite}" title="Trace" styleClass="toolbarButton bigButton"
                                        onclick="return isAnyTestSelected();" oncomplete="open_win('#{traceUrl}', 'trace_win')"
                                        style="padding-right: 1px">
                                        <table style="border-collapse: collapse;">
                                            <tr>
                                                <td>
                                                    <img src="webresource/images/trace.gif" />
                                                </td>
                                                <td rowspan="2" class="arrow" onclick="showButtonMenu(event, 'traceMenu', 'a')">
                                                    <f:verbatim>&amp;nbsp;&amp;nbsp;</f:verbatim>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <span>Trace</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </a4j:commandLink>
                                    <div id="traceMenu" style="display: none">
    	                                <h:commandLink onclick="return isAnyTestSelected();" styleClass="toolbarButton"
    	                                    action="#{showTableBean.traceIntoFile}" title="Trace into File">
    	                                    <img src="webresource/images/traceIntoFile.gif" />
    	                                    <span>Into File</span>
    	                                </h:commandLink>
                                    </div>
                                </td>
                                <td>
                                    <a4j:commandLink action="#{showTableBean.makeTestSuite}" title="Benchmark" styleClass="toolbarButton bigButton"
                                        onclick="return isAnyTestSelected();"
                                        oncomplete="goTo('#{rulesEditor}/test/benchmarkMethod.xhtml', 'content')">
                                        <img src="webresource/images/clock-icon.png" />
                                        <span>Benchmark</span>
                                    </a4j:commandLink>
                                </td>
                            </tr>
                        </table>
                    </h:form>
                </td>
                </c:if>

                <c:if test="#{showTableBean.table.executable}">
                    <td>
                        <h:form id="inputArgsForm">
                            <c:set var="traceUrl"
                                value="#{contextPath}/faces/pages/layout/frameView.xhtml?title=Trace&amp;treePage=faces/pages/modules/rulesEditor/trace/tree.xhtml&amp;relWidth=70&amp;mainPage=faces/pages/modules/rulesEditor/trace/showTraceTable.xhtml&amp;first=true&amp;uri=#{showTableBean.encodedUri}" />
                            <c:set target="#{inputArgsBean}" property="uri" value="#{showTableBean.uri}" />
                            <c:if test="#{inputArgsBean.methodHasParameters}">
                                <a4j:commandLink styleClass="toolbarButton bigButton" title="Run"
                                    onclick="showButtonMenu(event, 'inputArgsMenu', 'a');document.getElementById('inputArgsForm:runButton').show();document.getElementById('inputArgsForm:traceButton').hide();">
                                    <img src="webresource/images/run.gif" />
                                    <span>Run</span>
                                </a4j:commandLink>
                                <a4j:commandLink styleClass="toolbarButton bigButton" title="Trace"
                                    onclick="showButtonMenu(event, 'inputArgsMenu', 'a');document.getElementById('inputArgsForm:traceButton').show();document.getElementById('inputArgsForm:runButton').hide();">
                                    <img src="webresource/images/trace.gif" />
                                    <span>Trace</span>
                                </a4j:commandLink>
                                <div id="inputArgsMenu" style="display: none">
                                    <ui:include src="/pages/modules/rulesEditor/test/inputTestCase.xhtml" />
                                    <a4j:commandButton id="runButton" style="display: none"
                                        action="#{inputArgsBean.makeTestSuite}" value="Run" title="Run"
                                        oncomplete="goTo('#{rulesEditor}/test/runTestMethod.xhtml', 'content')" />
                                    <a4j:commandButton id="traceButton" style="display: none"
                                        action="#{inputArgsBean.makeTestSuite}" value="Trace" title="Trace"
                                        oncomplete="open_win('#{traceUrl}', 'trace_win')" />
                                </div>
                            </c:if>
                            <c:if test="#{not inputArgsBean.methodHasParameters}">
                                <a4j:commandLink action="#{showTableBean.makeTestSuite}" styleClass="toolbarButton bigButton" title="Run"
                                    oncomplete="goTo('#{rulesEditor}/test/runTestMethod.xhtml', 'content')">
                                    <img src="webresource/images/run.gif" />
                                    <span>Run</span>
                                </a4j:commandLink>
                                <a4j:commandLink action="#{showTableBean.makeTestSuite}" styleClass="toolbarButton bigButton"
                                    oncomplete="open_win('#{traceUrl}', 'trace_win')" title="Trace">
                                    <img src="webresource/images/trace.gif" />
                                    <span>Trace</span>
                                </a4j:commandLink>
                            </c:if>
                        </h:form>
                    </td>
                </c:if>

                <c:if test="#{showTableBean.hasTests}">
                    <td>
                        <h:form>
                            <a4j:commandLink styleClass="toolbarButton bigButton" title="Run All Tests"
                                action="#{showTableBean.runAllTestsForTable}"
                                oncomplete="goTo('#{rulesEditor}/test/runAllTests.xhtml', 'content')">
                                <img src="webresource/images/test_ok.gif" />
                                <span>Test</span>
                            </a4j:commandLink>
                        </h:form>
                    </td>
                </c:if>

                <c:if test="#{showTableBean.canCreateTest}">
                <td>
                    <a4j:commandLink action="#{tableCreatorWizardManager.startWizard}" styleClass="toolbarButton bigButton" title="Create new Test"
                        oncomplete="goTo('#{rulesEditor}/create/index.xhtml?initStep=test/step2.xhtml', 'content')">
                        <a4j:param assignTo="#{tableCreatorWizardManager.tableType}" value="TEST_DIRECT" />
                        <img src="webresource/images/test_new.gif" />
                        <span>Create Test</span>
                    </a4j:commandLink>
                </td>
                </c:if>

            </tr>
        </table>
    </div>

    <h:panelGroup rendered="#{not empty showTableBean.targetTables}">
        <div>
            <div style="font-weight: bold;">
                <h:outputText value="Target Table" />
                <h:outputText value="s" rendered="#{fn:length(showTableBean.targetTables) > 1}" />
                <h:outputText value=":" />
            </div>
            <ui:repeat value="#{showTableBean.targetTables}" var="targetTable">
            <div>
                <h:outputLink value="#{contextPath}/faces/pages/modules/rulesEditor/showTable.xhtml" target="content">
                    <f:param name="uri" value="#{targetTable.uri}" />
                    <h:outputText value="#{targetTable.name}" />
                </h:outputLink>
            </div>
            </ui:repeat>
        </div>
    </h:panelGroup>

    <!-- If table has any type of tests, including tests with test cases, run methods -->
    <h:panelGroup rendered="#{showTableBean.hasAnyTests}">
        <div style="font-weight: bold;">Available Tests:</div>
        <ui:repeat value="#{showTableBean.allTests}" var="test">
            <div>
                <h:outputLink value="#{contextPath}/faces/pages/modules/rulesEditor/showTable.xhtml" target="content">
                    <f:param name="uri" value="#{test.info.sourceUrl}" />
                    <h:outputText value="#{test.name}" />
                </h:outputLink>
            </div>
        </ui:repeat>
    </h:panelGroup>

    <div style="clear:both"></div>
    </c:if>

    <h:panelGroup rendered="#{showTableBean.hasProblems}" layout="block" style="margin-top: 10px;">
        <div style="font-weight: bold; font-size: 12px; margin: 0px 2px 4px 2px;">
            <span style="margin-right: 4px">Problems</span>
            <h:graphicImage url="/webresource/images/arrow_down.gif" title="Hide Problems"
                onclick="$j('#problemsPanel').toggle('fast');this.src=(this.title == 'Hide Problems' ? '#{contextPath}/images/arrow_right.gif' : '#{contextPath}/images/arrow_down.gif');this.title=(this.title == 'Hide Problems' ? 'Hide Problems' : 'Hide Problems');" />
        </div>
        <div id="problemsPanel">
            <ui:include src="/pages/modules/rulesEditor/messages.xhtml">
                <ui:param name="messages" value="#{showTableBean.problems}" />
                <ui:param name="editable" value="#{showTableBean.editable}" />
            </ui:include>
            <br />
        </div>
    </h:panelGroup>

    <br />

    <form target="hidden" name="editInExcelForm" method="post" action="#{contextPath}/action/launch">
        <input type="hidden" name="uri" value="" />
    </form>

    <h:panelGroup id="tePanel" layout="block">
        <rules:tableEditor table="#{showTableBean.table}" view="#{studio.tableView}"
            linkBase="#{rulesEditor}/showTable.xhtml" linkTarget="content"
            mode="#{showTableBean.mode}" editable="#{showTableBean.editable}"
            showFormulas="#{studio.showFormulas}"
            beforeSaveAction="#{showTableBean.beforeSaveAction}"
            afterSaveAction="#{showTableBean.afterSaveAction}" onBeforeSave="javascript:onBeforeSave();"
            onAfterSave="javascript:onAfterSave();" onSaveFailure="javascript:onSaveFailure();"
            excludeScripts="prototype">

            <h:outputLink value="javascript:editInExcel(document.forms.editInExcelForm)"
                rendered="#{showTableBean.editable}">Edit in Excel</h:outputLink>
            <h:outputLink value="javascript:search()">Search</h:outputLink>

        </rules:tableEditor>
    </h:panelGroup>

    <script>
    //<![CDATA[
        function search() {
           	var searchQuery = $j(PopupMenu.lastTarget).text();
            goTo("search/simpleSearch.xhtml?searchQuery=" + searchQuery);
        }

        function editInExcel(f) {
            f.uri.value = "#{showTableBean.uri}";
            f.submit();
        }

        function onBeforeSave() {
            showLoader();
        }

        function onAfterSave() {
            goTo("showTable.xhtml", "content");
            hideLoader();
        }

        function onSaveFailure() {
            hideLoader();
        }

        function isAnyTestSelected() {
            var numChecked = $j("#testTable :checked").length;
            if (numChecked > 0) {
            	return true;
            }

            alert('No tests selected');
    	    return false;
    	}

        function isAllTestsSelected() {
            return $j("#testTable :checkbox").length == $j("#testTable :checked").length;
        }

        function selectAllTests() {
    	    var selectAll = $j("#selectAll");
    	    $j("#testTable :checkbox").attr("checked", selectAll.is(":checked"));
    	}

        (function() {
            var selectAll = $j("#selectAll");
            $j("#testTable :checkbox").click(function() {
                selectAll.attr("checked", isAllTestsSelected());
            });
        })();
    //]]>
    </script>

</ui:composition>