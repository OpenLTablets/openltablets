<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:rules="http://openl-tablets.sourceforge.net/jsf">

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />

    <link href="#{contextPath}/css/advSearch.css" rel="stylesheet" />
    <script src="#{contextPath}/javascript/advSearch.js"></script>

<table><tr><td>
<h:form id="advSearchForm">
  <h:panelGrid columns="3" cellspacing="5" >
    <h:selectManyCheckbox value="#{advancedSearch.selectedTableTypes}" layout="lineDirection" id="tableType" style="display:inline">
      <f:selectItems value="#{advancedSearch.tableTypes}"/>
    </h:selectManyCheckbox>

    <h:outputLink value="javascript: void(0)" onclick="jsSetTableTypes(true)">Select All</h:outputLink>
    <h:outputLink value="javascript: void(0)" onclick="jsSetTableTypes(false)">Deselect All</h:outputLink>
  </h:panelGrid>

<fieldset><legend>Table Selector</legend>
  <table class="search-table">
  <tr>
    <th/>
    <th class="search" colspan="3">Table Attribute</th>
    <th class="search">Condition</th>
    <th class="search">Value</th>
    </tr>

    <c:forEach items="#{advancedSearch.tableElements}" var="searchTableElem" varStatus="status">
      <c:if test="#{status.index > 0}">
        <tr>
          <td colspan="7" align="#{searchTableElem.operator.group ? 'center' : 'value'}" class="#{searchTableElem.operator.group ? 'search-group' : 'search-element'}">
             <h:selectOneMenu value="#{searchTableElem.groupOperatorName}" onchange="alignGop(this)" styleClass="#{searchTableElem.operator.group ? 'search-group' : 'search-element'}">
               <f:selectItems value="#{advancedSearch.groupOperationValues}"/>
             </h:selectOneMenu>
          </td>
        </tr>
      </c:if>
      <tr>
        <td> </td>
        <td>
          <h:selectOneMenu value="#{searchTableElem.notFlag}">
            <f:selectItems value="#{advancedSearch.notFlagValues}"/>
          </h:selectOneMenu>
        </td>

        <td>
          <!-- {#searchTableElem.type} means 'header' or 'property' on UI-->
          <h:selectOneMenu value="#{searchTableElem.type}" id="type1_#{status.index}" onchange="makeValue1Visible(this, #{status.index})">
            <f:selectItems value="#{advancedSearch.typeValues}"/>
          </h:selectOneMenu>
        </td>

        <td>
          <h:inputText value="#{searchTableElem.elementValueName}" id="typeValue_#{status.index}" styleClass="search-input" />
        </td>

        <td>
          <h:selectOneMenu value="#{searchTableElem.opType2}">
            <f:selectItems value="#{advancedSearch.opTypeValues}"/>
          </h:selectOneMenu>
        </td>

        <td>
          <h:inputText value="#{searchTableElem.elementValue}" styleClass="search-input" />
        </td>

        <td>
          <a4j:commandLink title="Add Condition" action="#{advancedSearch.addCondition}"
            render="@form">
            <f:param name="index" value="#{status.index}" />
            <h:graphicImage url="/webresource/images/add_obj.gif" />
          </a4j:commandLink>

          <c:if test="#{status.index > 0}">
            <a4j:commandLink title="Remove Condition" action="#{advancedSearch.deleteCondition}"
              render="@form">
              <f:param name="index" value="#{status.index}" />
              <h:graphicImage url="/webresource/images/delete.gif"/>
            </a4j:commandLink>
          </c:if>
        </td>

      </tr>
    </c:forEach>

  </table>

</fieldset>

<fieldset><legend>Column Selector</legend>
<table class="search-table">
<tr>
<th/>
<th class="search" colspan="3">Column Attribute</th>
<th class="search" colspan="2">Condition</th>
<th class="search">Value</th>
</tr>

<c:forEach items="#{advancedSearch.columnElements}" var="searchColumnElem" varStatus="status">
  <c:if test="#{status.index > 0}">
    <tr>
      <td colspan="7" align="#{searchColumnElem.operator.group ? 'center' : 'value'}" class="#{searchColumnElem.operator.group ? 'search-group' : 'search-element'}">
         <h:selectOneMenu value="#{searchColumnElem.groupOperatorName}" onchange="alignGop(this)" styleClass="#{searchColumnElem.operator.group ? 'search-group' : 'search-element'}">
           <f:selectItems value="#{advancedSearch.groupOperationValues}"/>
         </h:selectOneMenu>
      </td>
    </tr>
  </c:if>

  <tr>
    <td> </td>
    <td>
      <h:selectOneMenu value="#{searchColumnElem.notFlag}">
        <f:selectItems value="#{advancedSearch.notFlagValues}"/>
      </h:selectOneMenu>
    </td>

     <td>
       <!-- #{searchColumnElem.type} means 'Column Name' or 'Column Type' on UI-->
       <h:selectOneMenu value="#{searchColumnElem.type}">
         <f:selectItems value="#{advancedSearch.columnTypeValues}"/>
       </h:selectOneMenu>
     </td>

    <td>
      <h:selectOneMenu value="#{searchColumnElem.opType1}">
        <f:selectItems value="#{advancedSearch.opTypeValues}"/>
      </h:selectOneMenu>
    </td>

    <td>
      <h:inputText value="#{searchColumnElem.elementValueName}" styleClass="search-input" />
    </td>

    <td>
      <h:selectOneMenu value="#{searchColumnElem.opType2}">
        <f:selectItems value="#{advancedSearch.opTypeValues}"/>
      </h:selectOneMenu>
    </td>

    <td>
      <h:inputText value="#{searchColumnElem.elementValue}" styleClass="search-input" />
    </td>

     <td>
        <a4j:commandLink title="Add Condition" action="#{advancedSearch.addColCondition}"
          render="@form">
          <f:param name="index" value="#{status.index}" />
          <h:graphicImage url="/webresource/images/add_obj.gif" />
        </a4j:commandLink>

        <c:if test="#{status.index > 0}">
            <a4j:commandLink title="Remove Condition" action="#{advancedSearch.deleteColCondition}"
              render="@form">
              <f:param name="index" value="#{status.index}" />
              <h:graphicImage url="/webresource/images/delete.gif"/>
            </a4j:commandLink>
        </c:if>
      </td>
  </tr>

</c:forEach>
</table>


</fieldset>

<br/>
<a4j:commandButton value="Search" action="#{advancedSearchRequest.search}" render="searchResults" />
</h:form></td>

</tr></table>

<h:messages infoClass="success" errorClass="error" showDetail="true" showSummary="false" tooltip="true" globalOnly="true"/>

<h:panelGroup id="searchResults">
    <c:forEach items="#{advancedSearchRequest.searchResults}" var="table">
        <br />
        <h:panelGroup>
            <img src="#{contextPath}/webresource/images/viewTable.gif" />
            <h:outputLink value="#{contextPath}/faces/pages/modules/rulesEditor/showTable.xhtml" target="content">
                <f:param name="uri" value="#{table.uri}" />
                <h:outputText value="View Table" />
            </h:outputLink>
        </h:panelGroup>
        <br />

        <h:panelGroup rendered="#{studio.model.editable}">
            <h:graphicImage url="#{contextPath}/webresource/images/excel.png" />
            <h:outputLink value="#{contextPath}/action/launch" target="hidden">
                <f:param name="uri" value="#{table.uri}" />
                <h:outputText value="View Table in Excel" />
            </h:outputLink>
        </h:panelGroup>

        <br /><br />

        <rules:tableEditor table="#{table}" editable="false" rendered="#{table != null}"
            linkBase="#{contextPath}/faces/facelets/tableeditor/showTable.xhtml" linkTarget="content"
            collapseProps="true" />

        <h:outputText value="No rows selected&lt;br/&gt;" rendered="#{table == null}" escape="false" />
     </c:forEach>
</h:panelGroup>

<script>
  function fixValue1Enabled() {
    var ind = 0;
    var el = document.getElementById("searchForm:type1_" + ind);
    for (;el; el=document.getElementById("searchForm:type1_" + (++ind)))
          makeValue1Visible(el, ind)
  }

  fixValue1Enabled();
</script>

</ui:composition>