<ui:composition
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:jsffn="http://rules.openl.org/taglibs/jsffn">

    <style>
        .page img {
            vertical-align: -3px;
        }
        .list-modules .list-item {
            position: relative;
        }
        .list-modules .list-item .editable-link-inner {
            position: absolute;
            top: 30%;
            right: -30px;
            padding-left: 11px;
        }
        .list > .list-item .path {
            color: #999;
            padding-left: 20px;
            float: right;
        }
    </style>

    <f:event type="preRenderView" listener="#{projectBean.init()}" />

    <ui:param name="editable" value="#{studio.model.editable}" />
    <ui:param name="project" value="#{studio.currentProjectDescriptor}" />
    <ui:param name="projectData" value="#{studio.currentProject}" />

    <div class="page">
        <div class="editable">
            <h1>
                <span>#{project.name}</span>
                <h:panelGroup rendered="#{editable}">
                <a href="javascript:void(0)" title="Edit" class="editable-link"
                   onclick="editProject()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                </h:panelGroup>
            </h1>

            <h:panelGroup layout="block" rendered="#{!empty project.comment}" style="margin:10px 0 15px; color:#555">
                <span>#{project.comment}</span>
            </h:panelGroup>
        </div>

        <div class="block-column">
            <div class="block">
                <h3>Summary</h3>
                <div class="block-content">
                    <table class="properties">
                        <tr>
                            <td>Version</td>
                            <td>#{projectData.version.versionName}</td>
                        </tr>
                        <tr>
                            <ui:param name="statusClass"
                                value="#{projectData.status == 'LOCAL' ? '' : (projectData.status == 'EDITING' ? 'badge-success' : 'badge-info')}" />
                            <td>Status</td>
                            <td>
                                <span class="badge #{statusClass}">#{projectData.status.displayValue}</span>
                                <h:panelGroup styleClass="badge badge-error"
                                    rendered="#{projectData.status != 'EDITING' and projectData.locked}"
                                    style="margin-left:3px">Locked</h:panelGroup>
                            </td>
                        </tr>
                        <h:panelGroup rendered="#{!empty projectData.firstVersion.versionInfo}">
                        <tr>
                            <td>Created At</td>
                            <td>
                                <h:outputText value="#{projectData.firstVersion.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Created By</td>
                            <td>#{projectData.firstVersion.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{!empty projectData.version.versionInfo}">
                        <tr>
                            <td>Modified At</td>
                            <td>
                                <h:outputText value="#{projectData.version.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Modified By</td>
                            <td>#{projectData.version.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                    </table>
                </div>
            </div>

            <div class="block editable">
                <h3>
                    <span>Modules</span>
                    <h:panelGroup rendered="#{editable}">
                        <a href="javascript:void(0)" title="Add Module" class="editable-link"
                           onclick="addModule()"><img src="webresource/images/add.png" style="opacity:0.4" /></a>
                    </h:panelGroup>
                </h3>
                <div class="block-content">
                    <div class="list list-modules">
                        <ui:repeat var="module" value="#{project.modules}" varStatus="i">
                            <ui:param name="needJavaClassName" value="#{module.type != 'API'}" />

                            <div id="#{i.index}currentModule" class="list-item editable-inner">
                                <div>
                                    <a href="##{jsffn:encodeURL(project.name)}/#{jsffn:encodeURL(module.name)}">#{module.name}</a>
                                    <span class="path">#{projectBean.getModulePath(module)}</span>
                                </div>
                                <h:panelGroup rendered="#{needJavaClassName}">
                                <div style="margin-top:4px">
                                    <span>#{module.type} </span>
                                    <span>#{module.classname}</span>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{!empty module.methodFilter and (!empty module.methodFilter.includes or !empty module.methodFilter.excludes)}">
                                <div style="margin-top:4px">
                                    <h:panelGroup rendered="#{!empty module.methodFilter.includes}">
                                        <div title="Included Methods">
                                            <img src="webresource/images/include.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.includes.toArray()}" var="include">
                                                #{include}
                                            </a4j:repeat>
                                        </div>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{!empty module.methodFilter.excludes}">
                                        <div title="Excluded Methods">
                                            <img src="webresource/images/exclude.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.excludes.toArray()}" var="exclude">
                                                #{exclude}
                                            </a4j:repeat>
                                        </div>
                                    </h:panelGroup>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{editable}">
                                    <a href="javascript:void(0)" title="Edit Module" class="editable-link-inner"
                                        onclick="editModule({name:'#{module.name}',path:'#{projectBean.getModulePath(module)}',type:'#{module.type}',class:'#{module.classname}',includes:'#{module.methodFilter.includes}',excludes:'#{module.methodFilter.excludes}'})"><img
                                            src="webresource/images/edit.png" style="opacity:0.4" /></a>
                                    <a href="javascript:void(0)" title="Remove Module" class="editable-link-inner"
                                       onclick="removeModule('#{module.name}')" style="right:-55px;padding-left: 5px"><img
                                            src="webresource/images/remove.png" style="opacity:0.4" /></a>
                                </h:panelGroup>
                            </div>
                        </ui:repeat>
                    </div>
                </div>
            </div>

            <h:panelGroup rendered="#{!empty project.dependencies or editable}">
            <div class="block editable">
                <h3>
                    <span>Dependencies</span>
                    <h:panelGroup rendered="#{editable}">
                        <a href="javascript:void(0)" title="Manage Dependencies" class="editable-link"
                           onclick="manageDependencies()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                    </h:panelGroup>
                </h3>
                <div class="block-content">
                    <h:panelGroup rendered="#{editable and empty project.dependencies}">
                        <a class="link-ref" href="javascript:void(0)" onclick="manageDependencies()">Click to add dependencies</a>
                    </h:panelGroup>
                    <div class="list">
                        <ui:repeat var="dependency" value="#{project.dependencies}">
                            <div class="list-item">
                                <h:panelGroup rendered="#{!empty studio.getProjectByName(dependency.name)}">
                                <a href="#project.xhtml?name=#{jsffn:encodeURL(dependency.name)}">#{dependency.name}</a>
                                <h:panelGroup rendered="#{dependency.autoIncluded}" styleClass="path">
                                    All Modules
                                </h:panelGroup>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{empty studio.getProjectByName(dependency.name)}">
                                    <span>#{dependency.name}</span>
                                    <span class="path" style="color:red">Could not find the project</span>
                                </h:panelGroup>
                            </div>
                        </ui:repeat>
                    </div>
                </div>
            </div>
            </h:panelGroup>
        </div>

        <h:panelGroup rendered="#{!empty project.classpath or editable}">
        <div class="block-column">
            <div class="block editable">
                <h3>
                    <span>Sources</span>
                    <h:panelGroup rendered="#{editable}">
                        <a href="javascript:void(0)" title="Manage Sources" class="editable-link"
                           onclick="manageSources()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                    </h:panelGroup>
                </h3>
                <div class="block-content">
                    <h:panelGroup rendered="#{editable and empty project.classpath}">
                        <a class="link-ref" href="javascript:void(0)" onclick="manageSources()">Click to add sources</a>
                    </h:panelGroup>
                    <ul class="enum">
                    <ui:repeat var="path" value="#{project.classpath}">
                        <li>
                            <h:outputText value="#{path.path}" />
                        </li>
                    </ui:repeat>
                    </ul>
                </div>
            </div>
        </div>
        </h:panelGroup>
    </div>

    <h:panelGroup rendered="#{editable}">

    <rich:popupPanel id="editProjectPopup" width="460" autosized="true">
        <f:facet name="header">
            <h:outputText value="Edit Project" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('editProjectPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="editProjectForm">
            <table class="properties properties-form wide">
                <tr>
                    <td class="required">Name</td>
                    <td><h:inputText id="projectName" value="#{project.name}"
                        validator="#{projectBean.validateProjectName}" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><a4j:outputPanel ajaxRendered="true">
                        <h:message for="projectName" styleClass="error" />
                    </a4j:outputPanel></td>
                </tr>
                <tr>
                    <td>Description</td>
                    <td><h:inputTextarea id="projectDescription" value="#{project.comment}" style="height:150px" /></td>
                </tr>
                <tr>
                    <td>Properties pattern for a file name</td>
                    <td><h:inputText id="propertiesFileNamePattern" value="#{project.propertiesFileNamePattern}" /></td>
                </tr>
                <tr>
                    <td>File name processor class</td>
                    <td><h:inputText id="propertiesFileNameProcessor" value="#{project.propertiesFileNameProcessor}"
                                     validator="#{projectBean.validatePropertiesFileNameProcessor}" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><a4j:outputPanel ajaxRendered="true">
                        <h:message for="propertiesFileNameProcessor" styleClass="error" />
                    </a4j:outputPanel></td>
                </tr>
            </table>

            <footer>
                <a4j:commandButton id="editProjectBtn" value="Update" action="#{projectBean.editName}"
                    styleClass="button-primary"
                    oncomplete="if(!#{facesContext.validationFailed}){ws.ui.hide('editProjectPopup');goTo(encodeURIComponent('#{project.name}'), true)}" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('editProjectPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="editModulePopup" width="470" autosized="true">
        <f:facet name="header">
            <h:outputText id="moduleHeader" value="Edit Module" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                 onclick="ws.ui.hide('editModulePopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="editModuleForm">
            <input type="hidden" id="moduleNameOld" name="moduleNameOld" />

            <table class="properties properties-form wide">
                <tr>
                    <td class="required">Name</td>
                    <td><h:inputText id="moduleName"
                        validator="#{projectBean.validateModuleName}" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><a4j:outputPanel ajaxRendered="true">
                        <h:message for="moduleName" styleClass="error" />
                    </a4j:outputPanel></td>
                </tr>
                <tr>
                    <td class="required">Path</td>
                    <td><h:inputText id="modulePath"
                        validator="#{projectBean.validateModulePath}" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td><a4j:outputPanel ajaxRendered="true">
                        <h:message for="modulePath" styleClass="error" />
                    </a4j:outputPanel></td>
                </tr>
                <tr>
                    <td class="required">Type</td>
                    <td>
                        <h:selectOneMenu id="moduleType">
                            <f:selectItem itemValue="API" itemLabel="API" />
                            <f:selectItem itemValue="STATIC" itemLabel="Static" />
                            <f:selectItem itemValue="DYNAMIC" itemLabel="Dynamic" />
                        </h:selectOneMenu>
                    </td>
                </tr>
                <tr id="classRow">
                    <td class="required">Class</td>
                    <td><h:inputText id="moduleClass" /></td>
                </tr>
                <tr><td class="delimeter"></td></tr>
                <tr>
                    <td>Included Methods (RegExp)</td>
                    <td><h:inputTextarea id="moduleIncludes" /></td>
                </tr>
                <tr>
                    <td>Excluded Methods (RegExp)</td>
                    <td><h:inputTextarea id="moduleExcludes" /></td>
                </tr>
            </table>

            <footer>
                <a4j:commandButton id="editModuleBtn" value="Save" action="#{projectBean.editModule}"
                    styleClass="button-primary"
                    oncomplete="if(!#{facesContext.validationFailed}){ws.ui.hide('editModulePopup');reloadCurrent()}" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('editModulePopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="removeModulePopup" width="290" autosized="true">
        <f:facet name="header">
            <h:outputText value="Remove Module" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('removeModulePopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false">
            <input type="hidden" id="moduleToRemove" name="moduleToRemove" />
            <div>
                <br />
                Are you sure you want to remove this module?
                <br /><br />
            </div>
            <footer>
                <a4j:commandButton value="Remove" action="#{projectBean.removeModule}"
                    styleClass="button-primary"
                    oncomplete="if(!#{facesContext.validationFailed}){ws.ui.hide('removeModulePopup');reloadCurrent();message('Module was removed successfully!', 7000);}" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('removeModulePopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="manageDependenciesPopup" width="510" autosized="true">
        <f:facet name="header">
            <h:outputText value="Manage Dependencies" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('manageDependenciesPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="manageDependenciesForm">
            <div style="overflow:auto; height:350px">
                <table id="dependenciesTable" class="table table-over w100">
                    <tr>
                        <th>Project Name</th>
                        <th style="width:67px">All Modules</th>
                    </tr>
                    <ui:repeat value="#{projectBean.dependencies}" var="dependency2">
                        <tr class="#{dependency2.selected ? 'active' : ''}">
                            <td><label><h:selectBooleanCheckbox value="#{dependency2.selected}" /> #{dependency2.item.name}</label></td>
                            <td style="text-align:center"><h:selectBooleanCheckbox value="#{dependency2.item.autoIncluded}"
                                title="Include all modules" /></td>
                        </tr>
                    </ui:repeat>
                </table>
            </div>

            <footer>
                <a4j:commandButton id="editDependenciesBtn" value="Save" action="#{projectBean.editDependencies}"
                    styleClass="button-primary"
                    oncomplete="ws.ui.hide('manageDependenciesPopup');reloadCurrent()" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('manageDependenciesPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="manageSourcesPopup" width="330" autosized="true">
        <f:facet name="header">
            <h:outputText value="Manage Sources" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('manageSourcesPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="manageSourcesForm">
            <h:inputTextarea id="sources" value="#{projectBean.sources}" style="width:310px;height:150px" />
            <footer>
                <a4j:commandButton id="editSourcesBtn" value="Save" action="#{projectBean.editSources}"
                    styleClass="button-primary"
                    oncomplete="ws.ui.hide('manageSourcesPopup');reloadCurrent()" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('manageSourcesPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <script>
    //<![CDATA[
        var initProjectName = $j("#projectName").val();               // Плохо, очень плохо!!!
        var initProjectDescription = $j("#projectDescription").val(); // Плохо, очень плохо!!!

        var initDependencies = $j("#dependenciesTable tr > td:first-child input:checked").get();
        var initDependencies2 = $j("#dependenciesTable tr.active > td:last-child input").map(function(){return this.checked}).get();

        var initSources = $j("#sources").val(); // Плохо, очень плохо!!!
        var initPropertiesFileNamePattern = $j("#propertiesFileNamePattern").val(); // Плохо, очень плохо!!!
        var initPropertiesFileNameProcessor = $j("#propertiesFileNameProcessor").val(); // Плохо, очень плохо!!!

        function editProject() {
            var btn = $j("#editProjectBtn");

            btn.prop("disabled", true);
            $j("#projectName").val(initProjectName);
            $j("#projectDescription").val(initProjectDescription);
            $j("#propertiesFileNamePattern").val(initPropertiesFileNamePattern);
            $j("#propertiesFileNameProcessor").val(initPropertiesFileNameProcessor);
            $j("#editProjectForm span.error").remove();

            ws.ui.show("editProjectPopup");

            $j("#projectName, #projectDescription, #propertiesFileNamePattern, #propertiesFileNameProcessor").on("keyup", function() {
                var name = $j("#projectName").val();
                var description = $j("#projectDescription").val();
                var propertiesFileNamePattern = $j("#propertiesFileNamePattern").val();
                var propertiesFileNameProcessor = $j("#propertiesFileNameProcessor").val();
                btn.prop("disabled", !name || (name == initProjectName && description == initProjectDescription &&
                                propertiesFileNamePattern == initPropertiesFileNamePattern &&
                                propertiesFileNameProcessor == initPropertiesFileNameProcessor));
            })
        }

        function addModule() {
            editModule();
        }

        function removeModule(module) {
            $j("#moduleToRemove").val(module);
            ws.ui.show("removeModulePopup");
        }

        function editModule(module) {
            var add = !module;

            if (add) {
                module = {
                    name: "",
                    path: "",
                    type: "API",
                    class: "",
                    includes: "",
                    excludes: ""
                };
            }

            if (module.includes) {
                module.includes = module.includes.substr(1, module.includes.length - 2).replace(/, /g, "\n");
            }
            if (module.excludes) {
                module.excludes = module.excludes.substr(1, module.excludes.length - 2).replace(/, /g, "\n");
            }

            var btn = $j("#editModuleBtn");
            btn.prop("disabled", true);

            $j("#moduleHeader").text((add ? "Add" : "Edit") + " Module");

            $j("#moduleNameOld").val(module.name);
            $j("#moduleName").val(module.name);
            $j("#modulePath").val(module.path);
            $j("#moduleType").val(module.type);
            $j("#moduleClass").val(module.class);
            $j('#classRow').toggle(module.type != 'API');
            $j("#moduleIncludes").val(module.includes);
            $j("#moduleExcludes").val(module.excludes);

            $j("#editModuleForm span.error").remove();

            $j("#editModuleForm .properties :input").on("keyup change", function() {
                var changed =
                        module.name != $j("#moduleName").val()
                     || module.path != $j("#modulePath").val()
                     || module.type != $j("#moduleType").val()
                     || module.class != $j("#moduleClass").val()
                     || module.includes != $j("#moduleIncludes").val()
                     || module.excludes != $j("#moduleExcludes").val();

                btn.prop("disabled", !changed);

                if (this.id == "moduleType") {
                    $j('#classRow').toggle(this.value != 'API');
                }
            })

            ws.ui.show("editModulePopup");
        }

        function manageDependencies() {
            var btn = $j("#editDependenciesBtn");

            btn.prop("disabled", true);
            $j("#dependenciesTable tr > td:first-child input").each(function() {
                var init = initDependencies.indexOf(this) > -1;
                this.checked = init;
                var row = $j(this).closest("tr");
                row.toggleClass("active", init);
                row.find("td:last-child input").prop("disabled", !init);
                if (init) {
                    row.find("td:last-child input").prop("checked", initDependencies2[initDependencies.indexOf(this)]);
                } else {
                    row.find("td:last-child input").prop("checked", true);
                }
            });

            $j("#dependenciesTable tr > td:first-child input").on("change", function() {
                var row = $j(this).closest("tr");
                row.toggleClass("active", this.checked);
                row.find("td:last-child input").prop("disabled", !this.checked);

                var changed = false;
                var checked = $j("#dependenciesTable tr > td:first-child input:checked");
                if (checked.length != initDependencies.length) {
                    changed = true;
                } else {
                    checked.each(function() {
                        if (!(initDependencies.indexOf(this) > -1)) {
                            changed = true;
                        }
                    });
                }
                btn.prop("disabled", !changed);
            });

            $j("#dependenciesTable tr > td:last-child input").on("change", function() {
                var projectCheck = $j(this).closest("tr").find("td:first-child input").get(0);
                btn.prop("disabled", initDependencies2[initDependencies.indexOf(projectCheck)] == this.checked);
            });

            ws.ui.show("manageDependenciesPopup");
        }

        function manageSources() {
            var btn = $j("#editSourcesBtn");

            btn.prop("disabled", true);
            $j("#sources").val(initSources);

            ws.ui.show("manageSourcesPopup");

            $j("#sources").on("keyup", function() {
                btn.prop("disabled", $j("#sources").val() == initSources);
            })
        }

    //]]>
    </script>

    </h:panelGroup>

</ui:composition>
