<ui:composition
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:jsffn="http://rules.openl.org/taglibs/jsffn">

    <style>
        .page img {
            vertical-align: -3px;
        }
        .list > .list-item .path {
            color: #999;
            padding-left: 20px;
            float: right;
        }
    </style>

    <f:event type="preRenderView" listener="#{projectBean.init()}" />

    <ui:param name="editable" value="false" />
    <ui:param name="project" value="#{studio.currentProjectDescriptor}" />
    <ui:param name="projectData" value="#{studio.currentProject}" />

    <div class="page">
        <div class="editable">
            <h1>
                <span>#{project.name}</span>
                <h:panelGroup rendered="#{studio.model.editable}">
                <a href="javascript:void(0)" title="Edit" class="editable-link"
                   onclick="showEditProjectPopup()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                </h:panelGroup>
            </h1>

            <h:panelGroup layout="block" rendered="#{!empty project.comment}" style="margin:10px 0 15px; color:#555">
                <span>#{project.comment}</span>
            </h:panelGroup>
        </div>

        <div class="block-column">
            <div class="block">
                <h3>Summary</h3>
                <div class="block-content">
                    <table class="properties">
                        <tr>
                            <td>Version</td>
                            <td>#{projectData.version.versionName}</td>
                        </tr>
                        <tr>
                            <ui:param name="statusClass"
                                value="#{projectData.status == 'LOCAL' ? '' : (projectData.status == 'EDITING' ? 'badge-success' : 'badge-info')}" />
                            <td>Status</td>
                            <td>
                                <span class="badge #{statusClass}">#{projectData.status.displayValue}</span>
                                <h:panelGroup styleClass="badge badge-error"
                                    rendered="#{projectData.status != 'EDITING' and projectData.locked}"
                                    style="margin-left:3px">Locked</h:panelGroup>
                            </td>
                        </tr>
                        <h:panelGroup rendered="#{!empty projectData.firstVersion.versionInfo}">
                        <tr>
                            <td>Created At</td>
                            <td>
                                <h:outputText value="#{projectData.firstVersion.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Created By</td>
                            <td>#{projectData.firstVersion.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{!empty projectData.version.versionInfo}">
                        <tr>
                            <td>Modified At</td>
                            <td>
                                <h:outputText value="#{projectData.version.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Modified By</td>
                            <td>#{projectData.version.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                    </table>
                </div>
            </div>

            <div class="block">
                <h3>Modules</h3>
                <div class="block-content">
                    <div class="list">
                        <ui:repeat var="module" value="#{project.modules}" varStatus="i">
                            <ui:param name="needJavaClassName" value="#{module.type != 'API'}" />

                            <div id="#{i.index}currentModule" class="list-item">
                                <div>
                                    <h:form style="display: inline">
                                        <a4j:commandLink action="#{mainBean.selectModule}"
                                            oncomplete="goTo('module.xhtml?#{jsffn:encodeURL(project.name)}/#{jsffn:encodeURL(module.name)}', true)">
                                            #{module.name}
                                            <f:param name="project" value="#{project.name}" />
                                            <f:param name="module" value="#{module.name}" />
                                        </a4j:commandLink>
                                    </h:form>
                                    <span class="path">#{projectBean.getModulePath(module)}</span>
                                </div>
                                <h:panelGroup rendered="#{needJavaClassName}">
                                <div style="margin-top:4px">
                                    <span>#{module.type} </span>
                                    <span>#{module.classname}</span>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{!empty module.methodFilter and (!empty module.methodFilter.includes or !empty module.methodFilter.excludes)}">
                                <div style="margin-top:4px">
                                    <h:panelGroup rendered="#{!empty module.methodFilter.includes}">
                                        <span title="Included Methods">
                                            <img src="webresource/images/include.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.includes.toArray()}" var="include">
                                                #{include}
                                            </a4j:repeat>
                                        </span>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{!empty module.methodFilter.excludes}">
                                        <span title="Excluded Methods">
                                            <img src="webresource/images/exclude.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.excludes.toArray()}" var="exclude">
                                                #{exclude}
                                            </a4j:repeat>
                                        </span>
                                    </h:panelGroup>
                                </div>
                                </h:panelGroup>
                            </div>

                            <h:panelGroup rendered="#{editable}">
                                <h:inputText  maxlength="100" size="40" value="#{module.name}" />
                                <h:selectOneMenu  value="#{module.type}">
                                    <ui:remove>
                                        <f:ajax event="change" execute="#{i.index}currentModule" render="#{i.index}currentModule" />
                                    </ui:remove>
                                    <f:selectItem itemValue="STATIC" itemLabel="Static" />
                                    <f:selectItem itemValue="DYNAMIC" itemLabel="Dynamic" />
                                    <f:selectItem itemValue="API" itemLabel="API" />
                                </h:selectOneMenu>
                                <h:inputText maxlength="100" size="40" value="#{module.classname}" rendered="#{needJavaClassName}"/>
                                <h:inputText maxlength="100" size="40" value="#{module.rulesRootPath.path}" />
                                <h:inputText maxlength="100" size="40" value="#{module.methodFilter.includes}" />
                                <h:inputText maxlength="100" size="40" value="#{module.methodFilter.excludes}" />

                                <a4j:commandLink title="Remove" action="#{repositoryProjectRulesConfig.deleteModule(module)}">
                                    <img style="margin-left: 3px; opacity: 0.5" src="webresource/images/close.gif" />
                                </a4j:commandLink>
                            </h:panelGroup>
                        </ui:repeat>
                        <a4j:commandLink action="#{repositoryProjectRulesConfig.addModule}" rendered="#{editable}"
                            value="Add new module" title="Add new module"/>
                    </div>
                </div>
            </div>

            <h:panelGroup rendered="#{!empty project.dependencies}">
            <div class="block">
                <h3>Dependencies</h3>
                <div class="block-content">
                    <div class="list">
                        <ui:repeat var="dependency" value="#{project.dependencies}">
                            <div class="list-item">
                                <a href="#project.xhtml?name=#{jsffn:encodeURL(dependency.name)}">#{dependency.name}</a>
                                <h:panelGroup rendered="#{dependency.autoIncluded}">
                                    <img src="webresource/images/ok.png" style="margin-left:21px" />
                                </h:panelGroup>
                            </div>
                        </ui:repeat>
                    </div>
                </div>
            </div>
            </h:panelGroup>
        </div>

        <h:panelGroup rendered="#{!empty project.classpath}">
        <div class="block-column">
            <div class="block">
                <h3>Sources</h3>
                <div class="block-content">
                    <ul class="enum">
                    <ui:repeat var="path" value="#{project.classpath}">
                        <li>
                            <h:outputText value="#{path.path}" />
                            <a4j:commandLink title="Remove" action="#{repositoryProjectRulesConfig.deleteClasspath(path)}"
                                rendered="#{editable}">
                                <img style="margin-left: 3px; opacity: 0.5" src="webresource/images/close.gif" />
                            </a4j:commandLink>
                        </li>
                    </ui:repeat>
                    </ul>
                </div>
            </div>
        </div>
        </h:panelGroup>
    </div>

    <h:panelGroup rendered="#{studio.model.editable}">

    <rich:popupPanel id="editProjectPopup" width="460" autosized="true">
        <f:facet name="header">
            <h:outputText value="Edit Project" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('editProjectPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="editProjectForm">
            <h:panelGrid columns="2" styleClass="formfields" cellspacing="1" columnClasses="label,">
                <span class="required">Name</span>
                <h:inputText id="projectName" value="#{project.name}" style="width: 250px"
                    validator="#{projectBean.validateProjectName}" />
                <h:outputText />
                <a4j:outputPanel ajaxRendered="true">
                        <h:message for="projectName" styleClass="error" />
                </a4j:outputPanel>
                <span>Description</span>
                <h:inputTextarea id="projectDescription" value="#{project.comment}" style="width:340px;height:150px" />
            </h:panelGrid>

            <hr />

            <h:panelGrid columns="2" styleClass="buttonPanel" cellpadding="0" cellspacing="0">
                <a4j:commandButton id="editProjectBtn" value="Update" action="#{projectBean.editName}"
                    styleClass="button-primary"
                    oncomplete="if(!#{facesContext.validationFailed}){ws.ui.hide('editProjectPopup');goTo('project.xhtml?name=' + encodeURIComponent('#{project.name}'), true)}" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('editProjectPopup');" />
            </h:panelGrid>
        </h:form>
    </rich:popupPanel>

    <script>
      //<![CDATA[
        var initProjectName = $j("#projectName").val();               // Плохо, очень плохо!!!
        var initProjectDescription = $j("#projectDescription").val(); // Плохо, очень плохо!!!

        function showEditProjectPopup() {
            $j("#editProjectBtn").prop("disabled", true);
            $j("#projectName").val(initProjectName);
            $j("#projectDescription").val(initProjectDescription);
            $j("#editProjectForm span.error").remove();

            ws.ui.show("editProjectPopup");

            var btn = $j("#editProjectBtn");

            $j("#projectName, #projectDescription").on("keyup", function() {
                var name = $j("#projectName").val();
                var description = $j("#projectDescription").val();
                btn.prop("disabled", !name || (name == initProjectName && description == initProjectDescription));
            })
        }

      //]]>
    </script>

    </h:panelGroup>

</ui:composition>
