<ui:composition
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:jsffn="http://rules.openl.org/taglibs/jsffn">

    <style>
        .page img {
            vertical-align: -3px;
        }
        .list > .list-item .path {
            color: #999;
            padding-left: 20px;
            float: right;
        }
    </style>

    <f:event type="preRenderView" listener="#{projectBean.init()}" />

    <ui:param name="editable" value="false" />
    <ui:param name="project" value="#{studio.currentProjectDescriptor}" />
    <ui:param name="projectData" value="#{studio.currentProject}" />

    <div class="page">
        <div class="editable">
            <h1>
                <span>#{project.name}</span>
                <h:panelGroup rendered="#{studio.model.editable}">
                <a href="javascript:void(0)" title="Edit" class="editable-link"
                   onclick="showEditProjectPopup()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                </h:panelGroup>
            </h1>

            <h:panelGroup layout="block" rendered="#{!empty project.comment}" style="margin:10px 0 15px; color:#555">
                <span>#{project.comment}</span>
            </h:panelGroup>
        </div>

        <div class="block-column">
            <div class="block">
                <h3>Summary</h3>
                <div class="block-content">
                    <table class="properties">
                        <tr>
                            <td>Version</td>
                            <td>#{projectData.version.versionName}</td>
                        </tr>
                        <tr>
                            <ui:param name="statusClass"
                                value="#{projectData.status == 'LOCAL' ? '' : (projectData.status == 'EDITING' ? 'badge-success' : 'badge-info')}" />
                            <td>Status</td>
                            <td>
                                <span class="badge #{statusClass}">#{projectData.status.displayValue}</span>
                                <h:panelGroup styleClass="badge badge-error"
                                    rendered="#{projectData.status != 'EDITING' and projectData.locked}"
                                    style="margin-left:3px">Locked</h:panelGroup>
                            </td>
                        </tr>
                        <h:panelGroup rendered="#{!empty projectData.firstVersion.versionInfo}">
                        <tr>
                            <td>Created At</td>
                            <td>
                                <h:outputText value="#{projectData.firstVersion.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Created By</td>
                            <td>#{projectData.firstVersion.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                        <h:panelGroup rendered="#{!empty projectData.version.versionInfo}">
                        <tr>
                            <td>Modified At</td>
                            <td>
                                <h:outputText value="#{projectData.version.versionInfo.createdAt}">
                                    <f:convertDateTime type="date" pattern="#{systemConfig['data.format.date']}"/>
                                </h:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td>Modified By</td>
                            <td>#{projectData.version.versionInfo.createdBy}</td>
                        </tr>
                        </h:panelGroup>
                    </table>
                </div>
            </div>

            <div class="block">
                <h3>Modules</h3>
                <div class="block-content">
                    <div class="list">
                        <ui:repeat var="module" value="#{project.modules}" varStatus="i">
                            <ui:param name="needJavaClassName" value="#{module.type != 'API'}" />

                            <div id="#{i.index}currentModule" class="list-item">
                                <div>
                                    <h:form style="display: inline">
                                        <a4j:commandLink action="#{mainBean.selectModule}"
                                            oncomplete="goTo('module.xhtml?#{jsffn:encodeURL(project.name)}/#{jsffn:encodeURL(module.name)}', true)">
                                            #{module.name}
                                            <f:param name="project" value="#{project.name}" />
                                            <f:param name="module" value="#{module.name}" />
                                        </a4j:commandLink>
                                    </h:form>
                                    <span class="path">#{projectBean.getModulePath(module)}</span>
                                </div>
                                <h:panelGroup rendered="#{needJavaClassName}">
                                <div style="margin-top:4px">
                                    <span>#{module.type} </span>
                                    <span>#{module.classname}</span>
                                </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{!empty module.methodFilter and (!empty module.methodFilter.includes or !empty module.methodFilter.excludes)}">
                                <div style="margin-top:4px">
                                    <h:panelGroup rendered="#{!empty module.methodFilter.includes}">
                                        <span title="Included Methods">
                                            <img src="webresource/images/include.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.includes.toArray()}" var="include">
                                                #{include}
                                            </a4j:repeat>
                                        </span>
                                    </h:panelGroup>

                                    <h:panelGroup rendered="#{!empty module.methodFilter.excludes}">
                                        <span title="Excluded Methods">
                                            <img src="webresource/images/exclude.png" style="opacity:0.6" />
                                            <a4j:repeat value="#{module.methodFilter.excludes.toArray()}" var="exclude">
                                                #{exclude}
                                            </a4j:repeat>
                                        </span>
                                    </h:panelGroup>
                                </div>
                                </h:panelGroup>
                            </div>

                            <h:panelGroup rendered="#{editable}">
                                <h:inputText  maxlength="100" size="40" value="#{module.name}" />
                                <h:selectOneMenu  value="#{module.type}">
                                    <ui:remove>
                                        <f:ajax event="change" execute="#{i.index}currentModule" render="#{i.index}currentModule" />
                                    </ui:remove>
                                    <f:selectItem itemValue="STATIC" itemLabel="Static" />
                                    <f:selectItem itemValue="DYNAMIC" itemLabel="Dynamic" />
                                    <f:selectItem itemValue="API" itemLabel="API" />
                                </h:selectOneMenu>
                                <h:inputText maxlength="100" size="40" value="#{module.classname}" rendered="#{needJavaClassName}"/>
                                <h:inputText maxlength="100" size="40" value="#{module.rulesRootPath.path}" />
                                <h:inputText maxlength="100" size="40" value="#{module.methodFilter.includes}" />
                                <h:inputText maxlength="100" size="40" value="#{module.methodFilter.excludes}" />

                                <a4j:commandLink title="Remove" action="#{repositoryProjectRulesConfig.deleteModule(module)}">
                                    <img style="margin-left: 3px; opacity: 0.5" src="webresource/images/close.gif" />
                                </a4j:commandLink>
                            </h:panelGroup>
                        </ui:repeat>
                        <a4j:commandLink action="#{repositoryProjectRulesConfig.addModule}" rendered="#{editable}"
                            value="Add new module" title="Add new module"/>
                    </div>
                </div>
            </div>

            <h:panelGroup rendered="#{true or !empty project.dependencies}">
            <div class="block editable">
                <h3>
                    <span>Dependencies</span>
                    <h:panelGroup rendered="#{studio.model.editable}">
                        <a href="javascript:void(0)" title="Manage Dependencies" class="editable-link"
                           onclick="showManageDependenciesPopup()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                    </h:panelGroup>
                </h3>
                <div class="block-content">
                    <div class="list">
                        <ui:repeat var="dependency" value="#{project.dependencies}">
                            <div class="list-item">
                                <h:panelGroup rendered="#{!empty studio.getProjectByName(dependency.name)}">
                                <a href="#project.xhtml?name=#{jsffn:encodeURL(dependency.name)}">#{dependency.name}</a>
                                <h:panelGroup rendered="#{dependency.autoIncluded}" styleClass="path">
                                    All Modules
                                </h:panelGroup>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{empty studio.getProjectByName(dependency.name)}">
                                    <span>#{dependency.name}</span>
                                    <span class="path" style="color:red">Could not find the project</span>
                                </h:panelGroup>
                            </div>
                        </ui:repeat>
                    </div>
                </div>
            </div>
            </h:panelGroup>
        </div>

        <div class="block-column">
            <div class="block editable">
                <h3>
                    <span>Sources</span>
                    <h:panelGroup rendered="#{studio.model.editable}">
                        <a href="javascript:void(0)" title="Manage Sources" class="editable-link"
                           onclick="showManageSourcesPopup()"><img src="webresource/images/edit.png" style="opacity:0.4" /></a>
                    </h:panelGroup>
                </h3>
                <div class="block-content">
                    <ul class="enum">
                    <ui:repeat var="path" value="#{project.classpath}">
                        <li>
                            <h:outputText value="#{path.path}" />
                        </li>
                    </ui:repeat>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <h:panelGroup rendered="#{studio.model.editable}">

    <rich:popupPanel id="editProjectPopup" width="460" autosized="true">
        <f:facet name="header">
            <h:outputText value="Edit Project" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('editProjectPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="editProjectForm">
            <h:panelGrid columns="2" styleClass="formfields" cellspacing="1" columnClasses="label,">
                <span class="required">Name</span>
                <h:inputText id="projectName" value="#{project.name}" style="width: 340px"
                    validator="#{projectBean.validateProjectName}" />
                <h:outputText />
                <a4j:outputPanel ajaxRendered="true">
                    <h:message for="projectName" styleClass="error" />
                </a4j:outputPanel>
                <span>Description</span>
                <h:inputTextarea id="projectDescription" value="#{project.comment}" style="width:340px;height:150px" />
            </h:panelGrid>

            <footer>
                <a4j:commandButton id="editProjectBtn" value="Update" action="#{projectBean.editName}"
                    styleClass="button-primary"
                    oncomplete="if(!#{facesContext.validationFailed}){ws.ui.hide('editProjectPopup');goTo('project.xhtml?name=' + encodeURIComponent('#{project.name}'), true)}" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('editProjectPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="manageDependenciesPopup" width="510" autosized="true">
        <f:facet name="header">
            <h:outputText value="Manage Dependencies" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('manageDependenciesPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="manageDependenciesForm">
            <div style="overflow:auto; height:350px">
                <table id="dependenciesTable" class="table table-over w100">
                    <tr>
                        <th>Project Name</th>
                        <th style="width:67px">All Modules</th>
                    </tr>
                    <ui:repeat value="#{projectBean.dependencies}" var="dependency2">
                        <tr class="#{dependency2.selected ? 'active' : ''}">
                            <td><label><h:selectBooleanCheckbox value="#{dependency2.selected}" /> #{dependency2.item.name}</label></td>
                            <td style="text-align:center"><h:selectBooleanCheckbox value="#{dependency2.item.autoIncluded}"
                                title="Include all modules" /></td>
                        </tr>
                    </ui:repeat>
                </table>
            </div>

            <footer>
                <a4j:commandButton id="editDependenciesBtn" value="Save" action="#{projectBean.editDependencies}"
                    styleClass="button-primary"
                    oncomplete="ws.ui.hide('manageDependenciesPopup');reloadCurrent()" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('manageDependenciesPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <rich:popupPanel id="manageSourcesPopup" width="330" autosized="true">
        <f:facet name="header">
            <h:outputText value="Manage Sources" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="ws.ui.hide('manageSourcesPopup')" alt="Close" />
        </f:facet>

        <h:form prependId="false" id="manageSourcesForm">
            <h:inputTextarea id="sources" value="#{projectBean.sources}" style="width:310px;height:150px" />
            <footer>
                <a4j:commandButton id="editSourcesBtn" value="Save" action="#{projectBean.editSources}"
                    styleClass="button-primary"
                    oncomplete="ws.ui.hide('manageSourcesPopup');reloadCurrent()" />
                <input type="button" value="Cancel" onclick="ws.ui.hide('manageSourcesPopup');" />
            </footer>
        </h:form>
    </rich:popupPanel>

    <script>
      //<![CDATA[
        var initProjectName = $j("#projectName").val();               // Плохо, очень плохо!!!
        var initProjectDescription = $j("#projectDescription").val(); // Плохо, очень плохо!!!

        var initDependencies = $j("#dependenciesTable tr > td:first-child input:checked").get();
        var initDependencies2 = $j("#dependenciesTable tr.active > td:last-child input").map(function(){return this.checked}).get();

        var initSources = $j("#sources").val(); // Плохо, очень плохо!!!

        function showEditProjectPopup() {
            var btn = $j("#editProjectBtn");

            btn.prop("disabled", true);
            $j("#projectName").val(initProjectName);
            $j("#projectDescription").val(initProjectDescription);
            $j("#editProjectForm span.error").remove();

            ws.ui.show("editProjectPopup");

            $j("#projectName, #projectDescription").on("keyup", function() {
                var name = $j("#projectName").val();
                var description = $j("#projectDescription").val();
                btn.prop("disabled", !name || (name == initProjectName && description == initProjectDescription));
            })
        }

        function showManageDependenciesPopup() {
            var btn = $j("#editDependenciesBtn");

            btn.prop("disabled", true);
            $j("#dependenciesTable tr > td:first-child input").each(function() {
                var init = initDependencies.indexOf(this) > -1;
                this.checked = init;
                var row = $j(this).closest("tr");
                row.toggleClass("active", init);
                row.find("td:last-child input").prop("disabled", !init);
                if (init) {
                    row.find("td:last-child input").prop("checked", initDependencies2[initDependencies.indexOf(this)]);
                } else {
                    row.find("td:last-child input").prop("checked", true);
                }
            });

            $j("#dependenciesTable tr > td:first-child input").on("change", function() {
                var row = $j(this).closest("tr");
                row.toggleClass("active", this.checked);
                row.find("td:last-child input").prop("disabled", !this.checked);

                var changed = false;
                var checked = $j("#dependenciesTable tr > td:first-child input:checked");
                if (checked.length != initDependencies.length) {
                    changed = true;
                } else {
                    checked.each(function() {
                        if (!(initDependencies.indexOf(this) > -1)) {
                            changed = true;
                        }
                    });
                }
                btn.prop("disabled", !changed);
            });

            $j("#dependenciesTable tr > td:last-child input").on("change", function() {
                var projectCheck = $j(this).closest("tr").find("td:first-child input").get(0);
                btn.prop("disabled", initDependencies2[initDependencies.indexOf(projectCheck)] == this.checked);
            });

            ws.ui.show("manageDependenciesPopup");
        }

        function showManageSourcesPopup() {
            var btn = $j("#editSourcesBtn");

            btn.prop("disabled", true);
            $j("#sources").val(initSources);

            ws.ui.show("manageSourcesPopup");

            $j("#sources").on("keyup", function() {
                btn.prop("disabled", $j("#sources").val() == initSources);
            })
        }

      //]]>
    </script>

    </h:panelGroup>

</ui:composition>
