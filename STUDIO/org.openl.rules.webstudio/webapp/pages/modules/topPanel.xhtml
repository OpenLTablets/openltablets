<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:a4j="http://richfaces.org/a4j">

    <ui:include src="/pages/modules/updateModule.xhtml" />
    <ui:include src="/pages/modules/exportModule.xhtml" />

    <c:set var="contextPath" value="#{facesContext.externalContext.request.contextPath}" />
    <c:set var="rProject" value="#{studio.currentProject}" />
    <c:set var="module" value="#{studio.currentModule}" />

    <h:panelGroup id="topPanel" layout="block">
        <div style="float: right; position: relative;margin-right: 35px">
            <h:panelGroup rendered="#{!empty rProject and studio.model.projectCompiledSuccessfully}">
                <ui:include src="/pages/modules/searchForm.xhtml" />
            </h:panelGroup>
       </div>

        <div>
            <h:form id="headerForm" prependId="false">
                <div class="buttonPanel">
					<a4j:ajax oncomplete="reloadCurrent()">
						<h:commandLink action="#{mainBean.reload}" title="Refresh" styleClass="imageButton"
							style="background:url('webresource/images/refresh.png')" />

                        <h:commandLink onclick="openUpdateModuleDialog();return false;"
                            title="Update module"
                            rendered="#{!empty module and studio.model.editable}"
                            styleClass="imageButton"
                            style="background:url('webresource/images/repository/update.png')"/>
                        <h:commandLink onclick="openExportModuleDialog();return false;"
                            title="Export module"
                            rendered="#{!empty module and studio.model.editable}"
                            styleClass="imageButton"
                            style="background:url('webresource/images/repository/export.png')"/>
                        <h:commandLink action="#{mainBean.saveProject}"
							title="Save the project to the Design Repository"
							rendered="#{!empty rProject and rProject.openedForEditing and studio.model.editable}"
							styleClass="imageButton"
							style="background:url('webresource/images/repository/checkin.gif')"/>
						<h:commandLink action="#{mainBean.editProject}"
							title="Edit the project; the project becomes read-only for all other users"
							rendered="#{!empty rProject and !rProject.localOnly and !rProject.locked and studio.model.canStartEditing}"
							styleClass="imageButton"
							style="background:url('webresource/images/repository/checkout.gif')" />
					</a4j:ajax>

					<h:outputLink value="#test/test.xhtml"
						title="Run #{treeBean.projectTestsCount} Test(s)"
						rendered="#{!empty module and treeBean.projectTestsCount > 0 and treeBean.canRun}"
						styleClass="imageButton button-dropdown" onclick="test(event)"
						style="background:url('webresource/images/test_ok.gif')" />
                    <h:panelGroup class="dropdown dropdown-form"
                            rendered="#{!empty module and treeBean.projectTestsCount > 0 and treeBean.canRun}">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#"><b class="caret" /></a>
                        <ul id="testSettings" class="dropdown-menu" role="menu" style="margin:7px 0 0 -34px">
                            <li onclick="event.stopPropagation()">
                                <span tabindex="-1">
                                    <span>Tests per page</span>
                                    <h:selectOneMenu id="pp" value="#{studio.testsPerPage}">
                                        <f:selectItem itemLabel="1" itemValue="1" />
                                        <f:selectItem itemLabel="5" itemValue="5" />
                                        <f:selectItem itemLabel="20" itemValue="20" />
                                        <f:selectItem itemLabel="All" itemValue="-1" />
                                    </h:selectOneMenu>
                                </span>
                            </li>
                            <li class="divider"></li>
                            <li onclick="event.stopPropagation()">
                                <span tabindex="-1" title="Show only failed test cases">
                                    <span>Failures Only</span>
                                    <input name="failuresOnly" type="checkbox"
                                        onclick="$j('#failuresSetting').toggle(this.checked)"
                                        value="true" checked="#{studio.testsFailuresOnly ? 'checked' : ''}"
                                        style="vertical-align:-2px;margin:-4px" />
                                </span>
                            </li>
                            <li id="failuresSetting" class="#{!studio.testsFailuresOnly ? 'hidden' : ''}"
                                onclick="event.stopPropagation()">
                                <span tabindex="-1">
                                    <span>Failures per test</span>
                                    <h:selectOneMenu id="failures" value="#{studio.testsFailuresPerTest}">
                                        <f:selectItem itemLabel="1" itemValue="1" />
                                        <f:selectItem itemLabel="5" itemValue="5" />
                                        <f:selectItem itemLabel="20" itemValue="20" />
                                        <f:selectItem itemLabel="All" itemValue="-1" />
                                    </h:selectOneMenu>
                                </span>
                            </li>
                            <li class="divider"></li>
                            <li onclick="event.stopPropagation()">
                                <span tabindex="-1" title="Show the result of running test case if it's complex">
                                    <span>Complex Result</span>
                                    <input name="complexResult" type="checkbox"
                                        value="true" checked="#{studio.showComplexResult ? 'checked' : ''}"
                                        style="vertical-align:-2px;margin:-4px" />
                                </span>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <span style="padding:6px 18px 7px">
                                    <a href="#test/test.xhtml" class="button" onclick="test(event)">Test</a>
                                </span>
                            </li>
                        </ul>
                    </h:panelGroup>

                    <script>
                        // TODO Add to namespace
                        function test(e) {
                            e.preventDefault();
                            var query = $j("#testSettings").find("select,input").serialize();
                            goTo("test/test.xhtml?" + query);
                        }
                    </script>

                    <h:panelGroup style="margin-left: 17px;" rendered="#{!empty module and (studio.model.canCreateTable or studio.model.canEditProject)}">
                        <h:outputLink rendered="#{studio.model.canCreateTable}" value="#create/index.xhtml"
                            title="Create new table" styleClass="button-primary">Create Table</h:outputLink>
                        <h:outputLink id="topRevertLink" rendered="#{studio.model.canEditProject}"
                            value="#revert.xhtml" title="Compare and/or roll back module changes against a specific date" styleClass="button" >Revert</h:outputLink>
                    </h:panelGroup>

                    <span style="margin-left: 13px;" />

                    <h:panelGroup id="topMorePanel" class="dropdown">
                        <h:form>
                        <a class="button dropdown-toggle" data-toggle="dropdown" href="#">
                            More<b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu" role="menu">
                            <h:panelGroup rendered="#{!empty module and studio.model.projectCompiledSuccessfully}">
                            <li><a tabindex="-1" href="#rulesDependencies.xhtml">Table Dependency Graph</a></li>
                            <li class="divider"></li>
                            </h:panelGroup>
                            <li><a tabindex="-1" target="_blank"
                                onclick="window.open('#{contextPath}/faces/pages/modules/compare.xhtml','Compare','width=1000,height=800,screenX=50,screenY=100,resizable=yes,scrollbars=yes,status=yes');return false;"
                                href="#">Compare Excel files</a></li>
                        </ul>
                        </h:form>
                    </h:panelGroup>
                </div>
            </h:form>
        </div>
    </h:panelGroup>
    

</ui:composition>
