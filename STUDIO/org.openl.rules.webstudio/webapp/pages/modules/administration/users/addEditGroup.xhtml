<?xml version="1.0" encoding="UTF-8"?>
<ui:composition
        xmlns:ui="http://java.sun.com/jsf/facelets"
        xmlns:h="http://java.sun.com/jsf/html"
        xmlns:f="http://java.sun.com/jsf/core"
        xmlns:a4j="http://richfaces.org/a4j"
        xmlns:rich="http://richfaces.org/rich"
>

    <style>
        #privilegesTable {
            display: table;
            font-size: 100%;
        }

        #privilegesTable > div {
            display: table-row;
        }

        #privilegesTable > div > div {
            padding: 6px 11px;
            text-align: center;
            display: table-cell;
            border-bottom: 1px dotted #ccc;

        }
        #privilegesTable > div:first-child {
            font-weight: bold;
            text-align: center;
        }
        #privilegesTable > div:first-child > div {
            border-bottom: 1px solid #ccc;
        }
        #privilegesTable > div:first-child > label {
            border-bottom: 1px solid #ccc;
            display: table-cell;
            cursor: pointer;
            color: #29d;
        }

        #privilegesTable > div:first-child > label div {
            padding: 6px;
        }

        #privilegesTable > div:first-child input[type="checkbox"] {
            display:none;
        }

        #privilegesTable > div:first-child input[type="checkbox"]:checked + div {
            background: #77d100;
            color: #fff;
        }

        .selectedRow {
            background: #eff7ff;
        }
        .selectedGroup {
            background: #77d100;
        }
        .selectedGroup a {
            color: #fff !important;
        }
    </style>

    <rich:popupPanel id="modalAddEditGroup" autosized="true" minWidth="670" maxWidth="670">
        <f:facet name="header">
            <h:outputText id="addHeader" value="Add New Group" />
            <h:outputText id="editHeader" value="Edit Group" style="display: none;" />
        </f:facet>

        <f:facet name="controls">
            <h:graphicImage value="/images/close.gif" class="close"
                onclick="hideAddGroup()" alt="Close" />
        </f:facet>

        <h:form id="addEditGroupForm">
            <div style="height: 530px; overflow: auto;">
            <table cellspacing="5">
                <tr>
                    <td>
                        <label class="required">Name:</label>
                    </td>
                    <td>
                        <h:inputText id="name" value="#{groupsBean.name}" validator="#{groupsBean.validateGroupName}"
                            style="margin-right: 7px;" />
                        <h:inputText id="newName" value="#{groupsBean.newName}" style="margin-right: 7px; display:none" />
                        <h:inputHidden id="oldName" value="#{groupsBean.oldName}" />
                        <a4j:outputPanel ajaxRendered="true" id="nameError">
                            <h:message for="name" styleClass="error" />
                            <h:message for="newName" styleClass="error" />
                        </a4j:outputPanel>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>Description:</label>
                    </td>
                    <td style="width: 100%; padding-right: 11px">
                        <h:inputTextarea id="description" value="#{groupsBean.description}"
                            style="width: 100%" />
                        <a4j:outputPanel ajaxRendered="true" id="descriptionError">
                            <h:message for="description" styleClass="error" />
                        </a4j:outputPanel>
                    </td>
                </tr>
            </table>
            <div id="privilegesTable"/>
            </div>

            <footer>
                <a4j:commandButton id="saveBtn" value="Save" action="#{groupsBean.addGroup}" data="#{facesContext.maximumSeverity}"
                    oncomplete="if(!event.data) hideAddGroup()" styleClass="button-primary"
                    render=":groupList :addUserGroups :editUserGroups :userList nameError addGroupPrivilegeList" />
                <a4j:commandButton id="editBtn" value="Save" action="#{groupsBean.editGroup}" data="#{facesContext.maximumSeverity}"
                    oncomplete="if(!event.data) hideAddGroup()" styleClass="button-primary" style="display: none"
                    render=":groupList :addUserGroups :editUserGroups :userList nameError addGroupPrivilegeList" />
                <input type="button" value="Cancel" onclick="hideAddGroup()" />
            </footer>

        </h:form>

    </rich:popupPanel>

    <script>
        $j("#privilegesTable td :checkbox").live("change", function(e) {
            checkPrivilege($j(e.target), this.checked);
            checkGroups();
        });

        function addGroup() {
            $j("#editHeader,#addEditGroupForm\\:newName,#addEditGroupForm\\:editBtn").hide();
            $j("#addHeader,#addEditGroupForm\\:name,#addEditGroupForm\\:saveBtn").show();

            $j("#addEditGroupForm\\:editBtn").hide();
            $j("#addEditGroupForm\\:saveBtn").show();

            $j("#addEditGroupForm\\:newName").attr("disabled", true);
            $j("#addEditGroupForm\\:name").attr("disabled", false);

            render();
            RichFaces.$("modalAddEditGroup").show();

        }

        function editGroup(name, description, isOnlyAdmin) {
            $j("#addHeader,#addEditGroupForm\\:name,#addEditGroupForm\\:saveBtn").hide();
            $j("#editHeader,#addEditGroupForm\\:newName,#addEditGroupForm\\:editBtn").show();

            $j("#addEditGroupForm\\:name").attr("disabled", true);
            $j("#addEditGroupForm\\:newName").attr("disabled", false);

            $j("#addEditGroupForm\\:oldName").val(name);
            $j("#addEditGroupForm\\:newName").val(name);
            $j("#addEditGroupForm\\:description").val(description);

            render(name);
            openGroup(name);
            $j("#privilegesTable input[value=ADMIN]").parent().toggleClass("disabled", isOnlyAdmin);

            RichFaces.$("modalAddEditGroup").show();
        }
        //<![CDATA[
        function openGroup(name) {
            checkPrivilegesByGroup(name);
            var group = groups[name];
            group.privileges && group.privileges.forEach(function (priv){
                var checkBox = $j("#privilegesTable input[name=privilege][value=" + priv + "]");
                checkBox.prop( "checked", true );
                checkBox.prop("indeterminate", false);
            });
            group.roles && group.roles.forEach(function (role){
                $j("#privilegesTable input[name=group][value=" + role + "]").prop( "checked", true );
            });
        }

        function checkPrivilegesByGroup(name) {
            var group = groups[name];
            group.allPrivileges.forEach(function (priv){
                var checkBox = $j("#privilegesTable input[name=privilege][value=" + priv + "]");
                checkBox.prop( "checked", false );
                checkBox.prop("indeterminate", true);
            });
        }

        function hideAddGroup() {
            $j('#groupsTable').trigger('refresh');
            RichFaces.$("modalAddEditGroup").hide();

            // Reset form
            $j("#addEditGroupForm\\:oldName,#addEditGroupForm\\:newName,#addEditGroupForm\\:name,#addEditGroupForm\\:description").val("");

            $j("#addEditGroupForm\\:nameError").text("");
            $j("#addEditGroupForm\\:descriptionError").text("");

        }

        function render(skipRole) {
            var html = "<div><div style='min-width: 150px;'>Privilege:</div>";
            $j.each(groups, function (name) {
                if (name !== skipRole) {
                    html += "<label><input type='checkbox' value='" + name + "' name='group'><div>" + name + "</div></label>";
                }
            });
            html+="</div>";
            $j.each(privileges, function (code, value) {
                html += "<div><label><input type='checkbox' value='" + code + "' name='privilege'>" + value + "</label>";
                $j.each(groups, function (name, gr) {
                    if (name === skipRole) {
                        return;
                    }
                    if ($j.inArray( code, gr.privileges ) !== -1 ) {
                        html += "<div><span class='yes-icon'/></div>";
                    } else if ($j.inArray( code, gr.allPrivileges ) !== -1 ) {
                        html += "<div><span class='check-icon'/></div>";
                    } else {
                        html += "<div><span/></div>";
                    }
                });
                html+="</div>";
            });

            $j("#privilegesTable").html(html);
        }
        //]]>
    </script>

</ui:composition>
