<project name="overallRelease" default="help" basedir=".">

	<description>
	    This script is designed to build all projects from base-pom in two ways:
		all projects are placed into single workspace and full SVN project structure.
	</description>

	<import file="VersionChangeScript/build.xml"/>

	<property file="VersionChangeScript/version.properties"/>
	<property name="rootFolder" value="../../../.." />

	<!-- BEGIN M2 PRESET -->
 	<property name="maven.commoncmd" value="" />

    <condition property="maven.line" value="--offline ${maven.commoncmd}">
        <istrue value="${offline}" />
    </condition>
    <property name="maven.line" value="${maven.commoncmd}" />

    <condition property="maven.executable" value="mvn.bat">
        <os family="windows" />
    </condition>
    <property name="maven.executable" value="mvn" />

    <condition property="maven.executable.real" value="${m2.home}/bin/${maven.executable}">
        <isset property="m2.home" />
    </condition>
    <property name="maven.executable.real" value="${maven.executable}"/>

    <presetdef name="maven">
        <exec failonerror="true" executable="${maven.executable.real}">
            <arg line="${maven.line}" />
        </exec>
    </presetdef>
    <!-- END M2 PRESET -->

	<target name="commitModule">
		<exec executable="svn">
			<arg line="commit ${moduleFolder}"/>
			<arg line="-m &quot;EPBDS-428 Temporary changed versions for release.&quot;"/>
			<arg line="--username ${svnLogin}"/>
			<arg line="--password ${svnPassword}"/>
		</exec>
	</target>

	<target name="fullCommit">
		<antcall target="commitModule">
			<param name="moduleFolder" value="${rootFolder}/BasePom/branches/iteration2_merge"/>
		</antcall>
		<antcall target="commitModule">
			<param name="moduleFolder" value="${rootFolder}/DEV/branches/iteration2_merge"/>
		</antcall>
		<antcall target="commitModule">
			<param name="moduleFolder" value="${rootFolder}/STUDIO/branches/iteration2_merge"/>
		</antcall>
		<antcall target="commitModule">
			<param name="moduleFolder" value="${rootFolder}/WSFrontend/branches/iteration2_merge"/>
		</antcall>
		<antcall target="commitModule">
			<param name="moduleFolder" value="${rootFolder}/Eclipse/branches/iteration2_merge"/>
		</antcall>
	</target>
	
	<target name="changeVersions">
		<antcall target="change">
			<param name="projects_root" value="${rootFolder}/BasePom/branches/iteration2_merge"/>
		</antcall>
		<antcall target="change">
			<param name="projects_root" value="${rootFolder}/DEV/branches/iteration2_merge"/>
		</antcall>
		<antcall target="change">
			<param name="projects_root" value="${rootFolder}/STUDIO/branches/iteration2_merge"/>
		</antcall>
		<antcall target="change">
			<param name="projects_root" value="${rootFolder}/WSFrontend/branches/iteration2_merge"/>
		</antcall>
		<antcall target="change">
			<param name="projects_root" value="${rootFolder}/Eclipse/branches/iteration2_merge"/>
		</antcall>
	</target>

	<target name="prepareModule">
		<maven dir="${moduleFolder}" failonerror="false">
			<arg line="release:prepare -DautoVersionSubmodules=true -DdevelopmentVersion=${version_for_poms_argument} -DscmCommentPrefix=EPBDS-345.[maven-release-plugin] -Dtag=release-${release_version_argument}  -Dusername=${svnLogin} -Dpassword=${svnPassword} -DreleaseVersion=${release_version_argument} -Darguments=&quot;-P internal-deploy&quot;"/>
		</maven>
		<exec executable="svn">
			<arg line="update ${moduleFolder}"/>
		</exec>
		<maven dir="${moduleFolder}" failonerror="false">
			<arg line="release:prepare -DautoVersionSubmodules=true -DdevelopmentVersion=${version_for_poms_argument} -DscmCommentPrefix=EPBDS-345.[maven-release-plugin] -Dtag=release-${release_version_argument}  -Dusername=${svnLogin} -Dpassword=${svnPassword} -DreleaseVersion=${release_version_argument} -Darguments=&quot;-P internal-deploy&quot;"/>
		</maven>
	</target>

	<target name="releaseModule" depends="prepareModule">
		<maven dir="${moduleFolder}" failonerror="false">
			<arg line="release:perform -Darguments=&quot;-P internal-deploy&quot;" />
		</maven>
	</target>
	
	<target name="prepare">
		<antcall target="changeVersions">
			<param name="version" value="${release_version_argument}"/>
			<param name="version_for_poms" value="${release_version_argument}"/>
		</antcall>
		<antcall target="fullCommit"/>
	</target>
	
	<target name="execute" depends="prepare">
		<!--antcall target="releaseModule">
			<param name="moduleFolder" value="${rootFolder}/BasePom/branches/iteration2_merge"/>
		</antcall>
		<antcall target="releaseModule">
			<param name="moduleFolder" value="${rootFolder}/DEV/branches/iteration2_merge"/>
		</antcall>
		<antcall target="releaseModule">
			<param name="moduleFolder" value="${rootFolder}/STUDIO/branches/iteration2_merge"/>
		</antcall>
		<antcall target="releaseModule">
			<param name="moduleFolder" value="${rootFolder}/WSFrontend/branches/iteration2_merge"/>
		</antcall-->
		<antcall target="releaseModule">
			<param name="moduleFolder" value="${rootFolder}/Eclipse/branches/iteration2_merge"/>
		</antcall>
	</target>
	
	<target name="fullRelease" depends="execute">
		<antcall target="changeVersions">
			<param name="version" value="${version_argument}"/>
			<param name="version_for_poms" value="${version_for_poms_argument}"/>
		</antcall>
		<antcall target="fullCommit"/>
	</target>
    <target name="help">
        <echo>
        	Run this script with predefined properties in arguments with target "fullRelease":

        		release_version_argument - version which will be used for release.
        		version_argument - version to use for new local working copy(in manifests and features).
	        	version_for_poms_argument - version to use for new local working copy(in poms for base-pom and dependensies versions)
    	    	svnLogin - The SVN username to use. 
        		svnPassword - The SVN password to use.

        	If this properties are not defined script will try to take them from file VersionChangeScript/version.properties.

        	Example of arguments of run:
        	-Drelease_version=5.2.0.001 -Dversion=5.2.0 -Dversion_for_poms=5.2.0-SNAPSHOT
        		-DsvnLogin=&lt;your SVN login&gt; -DsvnPassword=&lt;your SVN password&gt; fullRelease        	
        </echo>
    </target>
</project>
